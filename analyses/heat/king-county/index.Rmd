---
title: "Binomial Distribution Response to Urban Heat in King County"
author: "Joey Hulbert"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


|            |            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|:----------:|
|[Welcome](https://jmhulbert.github.io/redhot)|[Data](https://jmhulbert.github.io/redhot/data)|[Analyses](https://jmhulbert.github.io/redhot/analyses)|[Discussion](https://jmhulbert.github.io/redhot/discussion)|[Maps](https://jmhulbert.github.io/redhot/maps)
|             |           |            |            |            |


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(knitr)
library(kableExtra)
library(gghalves)
library(patchwork)
library(scales)
library(glmmTMB)
library(bbmle)
library(DHARMa)
```


# Purpose

The purpose of this page is to summarize an investigation of **tree health categories** as a *binary* response to urban heat (temperatures) for *trees within King County*.

*Response variables*
Binary dead top: no top dieback, top dieback

![](https://github.com/jmhulbert/redhot/blob/main/maps/index_files/figure-html/king-county-map-1.png?raw=true)


# Read Data

```{r}
data <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot/main/data/urban-data-modified.csv')
```

# Wrangle Data

## Remove dead trees

```{r}
# Remove Dead Trees
data.w.dead <- data 
data <- data %>% filter(field.tree.canopy.symptoms!="Tree is dead") %>% filter(field.dieback.percent<100) %>% droplevels()
```

```{r}
data$binary.tree.canopy.symptoms <- as.factor(data$binary.tree.canopy.symptoms)
levels(data$binary.tree.canopy.symptoms)
```

## Filter to King County Data

```{r}
data <- data %>% filter(Area=="King County") %>% droplevels()
```


# Visualize King County Data

```{r}
ggplot(data,aes(binary.tree.canopy.symptoms,DN_AF1))+geom_violin()+coord_flip()+theme_bw()
```

```{r}
p1 <- ggplot(data,aes(binary.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
p2 <- ggplot(data,aes(reclassified.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```
```{r}
p1 + p2
```

```{r}
p3 <-ggplot(data,aes(binary.tree.canopy.symptoms,DN_AF1, fill=binary.tree.canopy.symptoms ))+geom_boxplot(alpha=0.5)+theme_bw()+coord_flip() + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE) +labs(x="Tree Condition",y=NULL)
```

```{r}
p4 <-ggplot(data,aes(DN_AF1,fill=binary.tree.canopy.symptoms))+geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +theme_bw() +labs(x="Afternoon Temperature") +guides(fill=FALSE)
```

```{r}
p3 / p4
```


# Analyses

## Fit Models

## Model 1: top dieback and heat

```{r}
data$top.dieback <- as.factor(data$top.dieback)
```

```{r}
top.dieback.binomial.af <- glmmTMB(top.dieback ~ DN_AF1,data=data,family=binomial)
```

### Summary

```{r}
summary(top.dieback.binomial.af)
```


```{r}
levels(data$top.dieback)
```

There is no evidence for a relationship between top dieback and afternoon temperature in Tacoma.

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.2 <- expand.grid(
  DN_AF1 = seq(min(data$DN_AF1), max(data$DN_AF1), length.out = 1000)  # keeping predictor2 constant at its mean
)
```


```{r}
head(new.data.2)
```


```{r}
new.data.2$predicted_response <- predict(top.dieback.binomial.af, newdata = new.data.2, type = "response")
```

```{r}
# Create a data frame for predictions
new.data.2.inf <- expand.grid(
  DN_AF1 = seq(min(data$DN_AF1), max(150), length.out = 1000)  # keeping predictor2 constant at its mean
)
```

```{r}
new.data.2.inf$predicted_response <- predict(top.dieback.binomial.af, newdata = new.data.2.inf, type = "response")
```


```{r}
head(new.data.2)
```

```{r}
p <- ggplot(new.data.2.inf, aes(x = DN_AF1, y = predicted_response)) + geom_line() + labs(x = "Afternoon temperature (F)", y = "Dieback Probability") + scale_x_continuous(limits = c(80, 115)) +theme_minimal()

p
```



```{r}
p <- ggplot(new.data.2, aes(x = DN_AF1, y = predicted_response)) + geom_line() + labs(x = "Afternoon temperature (F)", y = "Dieback Probability") + scale_x_continuous(limits = c(80, 92)) +theme_minimal()

p2 <- p + annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = -Inf, xmax = 85, fill = alpha('#7fcdbb',0.5)) +
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = 85, xmax = 88.35, fill = alpha('#fe9929',0.5)) + 
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
          xmin = 88.35, xmax = Inf, fill = alpha('red',0.5))
p2 + annotate("text", x=82, y=.125, label= "Protect from\nDevelopment") + annotate("text", x=86.6, y=.125, label= "Provide\nExtra Care") + annotate("text", x=90.6, y=.125, label= "Most\nConcern")
```

# Summary

The probability of a tree having top dieback increases with afternoon temperature
