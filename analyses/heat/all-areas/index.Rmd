---
title: "Binomial Distribution Response to Urban Heat"
author: "Joey Hulbert"
date: "Last Update: `r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

|            |            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|:----------:|
|[Welcome](https://jmhulbert.github.io/redhot)|[Data](https://jmhulbert.github.io/redhot/data)|[Analyses](https://jmhulbert.github.io/redhot/analyses)|[Discussion](https://jmhulbert.github.io/redhot/discussion)|[Maps](https://jmhulbert.github.io/redhot/maps)
|             |           |            |            |            |


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(knitr)
library(kableExtra)
library(gghalves)
library(patchwork)
library(scales)
library(glmmTMB)
library(bbmle)
library(DHARMa)
```


# Purpose

The purpose of this page is to summarize an investigation of **tree health categories** as a *categorical* response to urban heat (temperatures).

Response variable: category: *healthy, unhealthy*


# Data Wrangling

```{r}
data <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot/main/data/urban-data-modified.csv')
```

## Remove dead trees

```{r}
# Remove Dead Trees
data.w.dead <- data 
data <- data %>% filter(field.tree.canopy.symptoms!="Tree is dead") %>% filter(field.dieback.percent<100) %>% droplevels()
```

```{r}
data$binary.tree.canopy.symptoms <- as.factor(data$binary.tree.canopy.symptoms)
levels(data$binary.tree.canopy.symptoms)
```

## Remove observations from Hoyt

```{r}
data <- data %>% filter(!str_detect(place_guess, "Hoyt") & !str_detect(place_guess, "hoyt"))
```


# Data Visualization

## Binary Tree Condition Categories

```{r}
ggplot(data,aes(binary.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
p1 <-ggplot(data,aes(binary.tree.canopy.symptoms,dist.from.mean.af, fill=binary.tree.canopy.symptoms ))+geom_boxplot(alpha=0.5)+theme_bw()+coord_flip() + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE) +labs(x="Tree Condition",y=NULL)
```

```{r}
p2 <-ggplot(data,aes(dist.from.mean.af,fill=binary.tree.canopy.symptoms))+geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +theme_bw() +labs(x="Distance from Mean Afternoon Temperature") +guides(fill=FALSE)
```

```{r}
p1 / p2
```

## Reclassified Tree Condition Categories

```{r}
ggplot(data,aes(reclassified.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
data$top.dieback <- as.factor(data$top.dieback)
data$thinning <- as.factor(data$thinning)
```

```{r}
ggplot(data,aes(reclassified.tree.canopy.symptoms,dist.from.mean.af ))+geom_boxplot()+theme_bw()+coord_flip()
```

## Temp and Site Type

```{r}
king <- data %>% filter(Area=="King County")
```

```{r}
king <- king %>% filter(field.optional...site.type=="Urban"|field.optional...site.type=="Suburban"|field.optional...site.type=="Rural")
```

```{r}
ggplot(king,aes(field.optional...site.type,dist.from.mean.af ))+geom_boxplot()+theme_bw()+coord_flip()
```


# Analyses

## Fit Models

```{r}
binomial.daily <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.daily + (1|Area),family=binomial,data=data)
binomial.am <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.am + (1|Area),data=data,family=binomial)
binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
binomial.pm <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.pm + (1|Area),data=data,family=binomial)
```

## Compare Models

```{r}
AICtab(binomial.daily,binomial.am,binomial.af,binomial.pm)
```

Afternoon heat was the best fit

## Response 1.0: healthy / unhealthy

```{r}
#binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
```

### Summary

```{r}
summary(binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$binary.tree.canopy.symptoms)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data$predicted_response <- predict(binomial.af, newdata = new.data, type = "response")
```

```{r}
ggplot(new.data, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```

The probability of tree being classified as unhealthy increases with distance from mean af

## Response 2.0: healthy / top-dieback 

```{r}
data.top <- data %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Dead Top") %>% droplevels()
```


```{r}
top.dieback.binomial.af <- glmmTMB(top.dieback ~ dist.from.mean.af + (1|Area),data=data.top,family=binomial)
```

### Summary

```{r}
summary(top.dieback.binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$top.dieback)
```

```{r}
p3 <-ggplot(data,aes(top.dieback,dist.from.mean.af, fill=top.dieback ))+geom_boxplot(alpha=0.5)+theme_bw()+coord_flip() + scale_fill_manual(name="Top Dieback",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE) +labs(x="Top Dieback",y=NULL)
```

```{r}
p4 <-ggplot(data,aes(dist.from.mean.af,fill=top.dieback))+geom_density(alpha=0.5) + scale_fill_manual(name="Top Dieback",values=c("#7fcdbb","#fe9929")) +theme_bw() +labs(x="Distance from Mean Afternoon Temperature") +guides(fill=FALSE)
```

```{r}
p3 / p4
```

The probability of a tree having top dieback increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.2 <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data.2$predicted_response <- predict(top.dieback.binomial.af, newdata = new.data.2, type = "response")
```

```{r}
ggplot(new.data.2, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```


## Response 3.0: healthy / thinning

```{r}
data.thin <- data %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Thinning") %>% droplevels()
```

```{r}
thinning.binomial.af <- glmmTMB(thinning ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
```

### Summary

```{r}
summary(thinning.binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$thinning)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.3 <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data.3$predicted_response <- predict(thinning.binomial.af, newdata = new.data.3, type = "response")
```

```{r}
ggplot(new.data.3, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```


## Compare Models

### Odds Ratios

Unhealthy Trees

```{r}

# Unhealthy Overall
coef(binomial.af)
exp(0.1487527)
```

Top Dieback

```{r}
# Top Dieback
coef(top.dieback.binomial.af)
exp(0.2046919)
```


Thinning

```{r}
# Thinning
coef(thinning.binomial.af)
exp(0.08554814)
```


> "An odds ratio greater than 1 implies that the predictor increases the odds of the outcome." 

Heat had the largest effect on predicting if trees had top dieback


## Adding co-variates

Note the models below were tested on filtered data. Data categorized as 'No Selection', 'Other' or blank were filtered out. 



### Co-Factor Model 1: adding size

#### Visualize co-factor

```{r}
data.size.filter <- data %>% filter(tree.size.simplified!="" & tree.size.simplified!="No Selection")
levels(as.factor(data.size.filter$tree.size.simplified))
```

`r nrow(data) - nrow(data.size.filter)` were removed from the data. `r nrow(data.size.filter)` observations were used in below the co-factor model adding size below.

```{r}
ggplot(data.size.filter,aes(tree.size.simplified))+geom_histogram(stat="count")+coord_flip()+theme_bw()
```

##### All Trees

```{r}
ggplot(data.size.filter,aes(binary.tree.canopy.symptoms)) +facet_wrap(~tree.size.simplified) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```


##### Trees with Dead Tops

```{r}
ggplot(data.size.filter,aes(top.dieback)) +facet_wrap(~tree.size.simplified) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```

##### Thinning Trees

```{r}
ggplot(data.size.filter,aes(thinning)) +facet_wrap(~tree.size.simplified) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```



#### Response 1.1 healthy / unhealthy

```{r}
binomial.af.size <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af +  tree.size.simplified +(1|Area),data=data.size.filter,family=binomial)
```

```{r}
summary(binomial.af.size)
```

#### Response 2.1 healthy / top-dieback 

```{r}
data.top.size <- data.size.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Dead Top") %>% droplevels()
```

```{r}
top.dieback.binomial.af.size <- glmmTMB(top.dieback ~ dist.from.mean.af + tree.size.simplified + (1|Area),data=data.top.size,family=binomial)
```

```{r}
summary(top.dieback.binomial.af.size)
```

#### Response 3.1 healthy / thinning

```{r}
data.thin.size <- data.size.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Thinning") %>% droplevels()
```

```{r}
thinning.binomial.af.size <- glmmTMB(thinning ~ dist.from.mean.af + tree.size.simplified + (1|Area),data=data.thin.size,family=binomial)
```

```{r}
summary(thinning.binomial.af.size)
```


### Co-Factor Model 2: adding location

#### Visualize co-factor

```{r}
data.site.filter <- data %>% filter(field.optional...site.location.description!="" & field.optional...site.location.description!="No Selection" & field.optional...site.location.description!="Other") %>% droplevels()
levels(as.factor(data.site.filter$field.optional...site.location.description))
```

`r nrow(data) - nrow(data.site.filter)` were removed from the data. `r nrow(data.site.filter)` observations were used in below the co-factor model adding size below.

```{r}
ggplot(data.site.filter,aes(field.optional...site.location.description))+geom_histogram(stat="count")+coord_flip()+theme_bw()
```

##### All Trees

```{r}
ggplot(data.site.filter,aes(binary.tree.canopy.symptoms)) +facet_wrap(~field.optional...site.location.description) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```


##### Trees with Dead Tops

```{r}
ggplot(data.site.filter,aes(top.dieback)) +facet_wrap(~field.optional...site.location.description) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```

##### Thinning Trees

```{r}
ggplot(data.site.filter,aes(thinning)) +facet_wrap(~field.optional...site.location.description) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```



#### Response 1.2 healthy / unhealthy

```{r}
binomial.af.site <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + field.optional...site.location.description  + (1|Area),data=data.site.filter,family=binomial)
```

```{r}
summary(binomial.af.site)
```

#### Response 2.2 healthy / top-dieback 

```{r}
data.top.site <- data.site.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Dead Top") %>% droplevels()
```

```{r}
top.dieback.binomial.af.site <- glmmTMB(top.dieback ~ dist.from.mean.af + field.optional...site.location.description + (1|Area),data=data.top.site,family=binomial)
```

```{r}
summary(top.dieback.binomial.af.site)
```

#### Response 3.2 healthy / thinning

```{r}
data.thin.site <- data.size.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Thinning") %>% droplevels()
```

```{r}
thinning.binomial.af.site <- glmmTMB(top.dieback ~ dist.from.mean.af + field.optional...site.location.description + (1|Area),data=data.thin.site,family=binomial)
```

```{r}
summary(thinning.binomial.af.site)
```


### Co-Factor Model 3: adding both size and location - filtered data 

```{r}
data.size.site.filter <- data.site.filter %>% filter(tree.size.simplified!="" & tree.size.simplified!="No Selection")
levels(as.factor(data.size.site.filter$tree.size.simplified))
```

`r nrow(data) - nrow(data.size.site.filter)` were removed from the data. `r nrow(data.size.site.filter)` observations were used in below the co-factor model adding size below.

```{r}
binomial.af.size.site <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + field.optional...site.location.description + tree.size.simplified +(1|Area),data=data.size.site.filter,family=binomial)
```

```{r}
summary(binomial.af.size.site)
```

With the data we have available and above model, there is no evidence size or site location have a significant effect on the probability of a tree having dieback.

Generally there is a lack of statistical evidence for a relationship between size or site location on tree health. However, we should revisit it with the larger (urban and non urban dataset). 
