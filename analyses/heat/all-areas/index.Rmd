---
title: "Binomial Distribution Response to Urban Heat"
author: "Joey Hulbert"
date: "Last Update: `r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

|            |            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|:----------:|
|[Welcome](https://jmhulbert.github.io/redhot)|[Data](https://jmhulbert.github.io/redhot/data)|[Analyses](https://jmhulbert.github.io/redhot/analyses)|[Discussion](https://jmhulbert.github.io/redhot/discussion)|[Maps](https://jmhulbert.github.io/redhot/maps)|
|             |           |            |            |            |

|            |            |            | Analyses   |            |            |            |
|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|
|[Urban Heat](https://jmhulbert.github.io/redhot/analyses/heat/)|[All Areas](https://jmhulbert.github.io/redhot/analyses/heat/all-areas)|[Portland](https://jmhulbert.github.io/redhot/analyses/heat/portland)|[Tacoma](https://jmhulbert.github.io/redhot/analyses/heat/tacoma)|[King County](https://jmhulbert.github.io/redhot/analyses/heat/king-county)|[iNaturalist](https://jmhulbert.github.io/redhot/analyses/inaturalist/)|[City Inventories]((https://jmhulbert.github.io/redhot/analyses/city-trees/))|
|             |           |            |            |            |            |            |

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(knitr)
library(kableExtra)
library(gghalves)
library(patchwork)
library(scales)
library(glmmTMB)
library(bbmle)
library(DHARMa)
```

# ALL AREAS

# Purpose

The purpose of this page is to summarize an investigation of **tree health categories** as a *categorical* response to urban heat (temperatures).

Response variable: category: *healthy, unhealthy*


# Data Wrangling

```{r}
data <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot/main/data/urban-data-modified.csv')
```

## Remove dead trees

```{r}
# Remove Dead Trees
data.w.dead <- data 
data <- data %>% filter(field.tree.canopy.symptoms!="Tree is dead") %>% filter(field.dieback.percent<100) %>% droplevels()
```

```{r}
data$binary.tree.canopy.symptoms <- as.factor(data$binary.tree.canopy.symptoms)
levels(data$binary.tree.canopy.symptoms)
```

## Remove observations from Hoyt

```{r}
data <- data %>% filter(!str_detect(place_guess, "Hoyt") & !str_detect(place_guess, "hoyt"))
```


# Data Visualization

## Binary Tree Condition Categories

```{r}
ggplot(data,aes(binary.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
p1 <-ggplot(data,aes(binary.tree.canopy.symptoms,dist.from.mean.af, fill=binary.tree.canopy.symptoms ))+geom_boxplot(alpha=0.5)+theme_bw()+coord_flip() + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE) +labs(x="Tree Condition",y=NULL)
```

```{r}
p2 <-ggplot(data,aes(dist.from.mean.af,fill=binary.tree.canopy.symptoms))+geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +theme_bw() +labs(x="Distance from Mean Afternoon Temperature") +guides(fill=FALSE)
```

```{r}
p1 / p2
```

## Reclassified Tree Condition Categories

```{r}
ggplot(data,aes(reclassified.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
data$top.dieback <- as.factor(data$top.dieback)
data$thinning <- as.factor(data$thinning)
```

```{r}
ggplot(data,aes(reclassified.tree.canopy.symptoms,dist.from.mean.af ))+geom_boxplot()+theme_bw()+coord_flip()
```

## Temp and Site Type

```{r}
king <- data %>% filter(Area=="King County")
```

```{r}
king <- king %>% filter(field.optional...site.type=="Urban"|field.optional...site.type=="Suburban"|field.optional...site.type=="Rural")
```

```{r}
ggplot(king,aes(field.optional...site.type,dist.from.mean.af ))+geom_boxplot()+theme_bw()+coord_flip()
```


# Analyses

## Time Series Model Fit

```{r}
binomial.daily <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.daily + (1|Area),family=binomial,data=data)
binomial.am <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.am + (1|Area),data=data,family=binomial)
binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
binomial.pm <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.pm + (1|Area),data=data,family=binomial)
```

### Compare Time Series Models

```{r}
AICtab(binomial.daily,binomial.am,binomial.af,binomial.pm)
```

Afternoon heat was the best fit

## Response 1.0: healthy / unhealthy

```{r}
#binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
```

### Summary

```{r}
summary(binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$binary.tree.canopy.symptoms)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 


```{r}
#predict(binomial.af,data[data$DN_AF1=0,])
#predict(binomial.af,DN_AF1=0)
```




### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data$predicted_response <- predict(binomial.af, newdata = new.data, type = "response")
```

```{r}
p1 <- ggplot(new.data, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from mean (F)", y = "Predicted Response") +
  theme_minimal() 
p1
```

```{r}
# Create a data frame for predictions
new.data.2.inf <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(100), length.out = 1000), Area = 0)  # keeping predictor2 constant at its mean
```

```{r}
new.data.2.inf$predicted_response <- predict(binomial.af, newdata = new.data.2.inf, type = "response")
```


```{r}
p2 <- ggplot(new.data.2.inf, aes(x = dist.from.mean.af, y = predicted_response)) + geom_line() + labs(x = "Distance from mean (F)", y = "Predicted Response") + scale_x_continuous(limits = c(-5, 40)) +theme_minimal()

p2
```


```{r}
p1 + p2
```

Probability when standardized temperature value is -2

```{r}
new_data <- data.frame(dist.from.mean.af = -2,Area=0)
predicted_response <- predict(binomial.af, newdata = new_data, type = "response")
print(predicted_response)
```


Probability when standardized temperature value is 0

```{r}
new_data <- data.frame(dist.from.mean.af = 0,Area=0)
predicted_response <- predict(binomial.af, newdata = new_data, type = "response")
print(predicted_response)
```

Probability when standardized temperature value is 2

```{r}
new_data <- data.frame(dist.from.mean.af = 2,Area=0)
predicted_response <- predict(binomial.af, newdata = new_data, type = "response")
print(predicted_response)
```




The probability of tree being classified as unhealthy increases with distance from mean af

## Response 2.0: healthy / top-dieback 

```{r}
data.top <- data %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Dead Top") %>% droplevels()
```


```{r}
top.dieback.binomial.af <- glmmTMB(top.dieback ~ dist.from.mean.af + (1|Area),data=data.top,family=binomial)
```

### Summary

```{r}
summary(top.dieback.binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$top.dieback)
```

```{r}
p3 <-ggplot(data,aes(top.dieback,dist.from.mean.af, fill=top.dieback ))+geom_boxplot(alpha=0.5)+theme_bw()+coord_flip() + scale_fill_manual(name="Top Dieback",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE) +labs(x="Top Dieback",y=NULL)
```

```{r}
p4 <-ggplot(data,aes(dist.from.mean.af,fill=top.dieback))+geom_density(alpha=0.5) + scale_fill_manual(name="Top Dieback",values=c("#7fcdbb","#fe9929")) +theme_bw() +labs(x="Distance from Mean Afternoon Temperature") +guides(fill=FALSE)
```

```{r}
p3 / p4
```

The probability of a tree having top dieback increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.2 <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data.2$predicted_response <- predict(top.dieback.binomial.af, newdata = new.data.2, type = "response")
```

```{r}
ggplot(new.data.2, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```

Probability when standardized temperature value is 0

```{r}
new_data <- data.frame(dist.from.mean.af = 0,Area=0)
predicted_response <- predict(top.dieback.binomial.af, newdata = new_data, type = "response")
print(predicted_response)
```

Probability when standardized temperature value is 2

```{r}
new_data <- data.frame(dist.from.mean.af = 2,Area=0)
predicted_response <- predict(top.dieback.binomial.af, newdata = new_data, type = "response")
print(predicted_response)
```





## Response 3.0: healthy / thinning

```{r}
data.thin <- data %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Thinning Canopy") %>% droplevels()
```

```{r}
thinning.binomial.af <- glmmTMB(thinning ~ dist.from.mean.af + (1|Area),data=data.thin,family=binomial)
```

### Summary

```{r}
summary(thinning.binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$thinning)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.3 <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data.3$predicted_response <- predict(thinning.binomial.af, newdata = new.data.3, type = "response")
```

```{r}
ggplot(new.data.3, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```


### Compare models  

#### Odds Ratios

Unhealthy Trees

```{r}

# Unhealthy Overall
coef(binomial.af)
exp(0.1397678)
```

Top Dieback

```{r}
# Top Dieback
coef(top.dieback.binomial.af)
exp(0.2385653)
```


Thinning

```{r}
# Thinning
coef(thinning.binomial.af)
exp(0.09135893)
```


> "An odds ratio greater than 1 implies that the predictor increases the odds of the outcome." 

Heat had the largest effect on predicting if trees had top dieback


## Models with Co-Factors

Note the models below were tested on filtered data. Data categorized as 'No Selection', 'Other' or blank were filtered out. 



### Co-Factor Model 1: adding size

#### Visualize co-factor

```{r}
data.size.filter <- data %>% filter(tree.size.simplified!="" & tree.size.simplified!="No Selection")
levels(as.factor(data.size.filter$tree.size.simplified))
```

`r nrow(data) - nrow(data.size.filter)` were removed from the data. `r nrow(data.size.filter)` observations were used in below the co-factor model adding size below.

```{r}
ggplot(data.size.filter,aes(tree.size.simplified))+geom_histogram(stat="count")+coord_flip()+theme_bw()
```

##### All Trees

```{r}
ggplot(data.size.filter,aes(binary.tree.canopy.symptoms)) +facet_wrap(~tree.size.simplified) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```


##### Trees with Dead Tops

```{r}
ggplot(data.size.filter,aes(top.dieback)) +facet_wrap(~tree.size.simplified) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```

##### Thinning Trees

```{r}
ggplot(data.size.filter,aes(thinning)) +facet_wrap(~tree.size.simplified) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```



#### Response 1.1 healthy / unhealthy

```{r}
binomial.af.size <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af +  tree.size.simplified +(1|Area),data=data.size.filter,family=binomial)
```

```{r}
summary(binomial.af.size)
```

#### Response 2.1 healthy / top-dieback 

```{r}
data.top.size <- data.size.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Dead Top") %>% droplevels()
```

```{r}
top.dieback.binomial.af.size <- glmmTMB(top.dieback ~ dist.from.mean.af + tree.size.simplified + (1|Area),data=data.top.size,family=binomial)
```

```{r}
summary(top.dieback.binomial.af.size)
```

#### Response 3.1 healthy / thinning

```{r}
data.thin.size <- data.size.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Thinning Canopy") %>% droplevels()
```

```{r}
thinning.binomial.af.size <- glmmTMB(thinning ~ dist.from.mean.af + tree.size.simplified + (1|Area),data=data.thin.size,family=binomial)
```

```{r}
summary(thinning.binomial.af.size)
```


### Co-Factor Model 2: adding location

#### Visualize co-factor

```{r}
data.site.filter <- data %>% filter(field.optional...site.location.description!="" & field.optional...site.location.description!="No Selection" & field.optional...site.location.description!="Other") %>% droplevels()
levels(as.factor(data.site.filter$field.optional...site.location.description))
```

`r nrow(data) - nrow(data.site.filter)` were removed from the data. `r nrow(data.site.filter)` observations were used in below the co-factor model adding size below.

```{r}
ggplot(data.site.filter,aes(field.optional...site.location.description))+geom_histogram(stat="count")+coord_flip()+theme_bw()
```

##### All Trees

```{r}
ggplot(data.site.filter,aes(binary.tree.canopy.symptoms)) +facet_wrap(~field.optional...site.location.description) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```


##### Trees with Dead Tops

```{r}
ggplot(data.site.filter,aes(top.dieback)) +facet_wrap(~field.optional...site.location.description) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```

##### Thinning Trees

```{r}
ggplot(data.site.filter,aes(thinning)) +facet_wrap(~field.optional...site.location.description) +geom_histogram(stat="count")+theme_bw()+coord_flip()
```



#### Response 1.2 healthy / unhealthy

```{r}
binomial.af.site <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + field.optional...site.location.description  + (1|Area),data=data.site.filter,family=binomial)
```

```{r}
summary(binomial.af.site)
```

#### Response 2.2 healthy / top-dieback 

```{r}
data.top.site <- data.site.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Dead Top") %>% droplevels()
```

```{r}
top.dieback.binomial.af.site <- glmmTMB(top.dieback ~ dist.from.mean.af + field.optional...site.location.description + (1|Area),data=data.top.site,family=binomial)
```

```{r}
summary(top.dieback.binomial.af.site)
```

#### Response 3.2 healthy / thinning

```{r}
data.thin.site <- data.site.filter %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Thinning Canopy") %>% droplevels()
```

```{r}
thinning.binomial.af.site <- glmmTMB(thinning ~ dist.from.mean.af + field.optional...site.location.description + (1|Area),data=data.thin.site,family=binomial)
```

```{r}
summary(thinning.binomial.af.site)
```


# Overall Summary

## Core Models - 3 responses

| Area       | Response   | Explanatory| df.resid  | Estimate   | Std.Error  | z-val       | Pr(>z)     | Signif.    |
|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|
All Areas | healthy/unhealthy | Dist from Mean AF | 1101 | 0.13977 |   0.03219 |  4.343 | 1.41e-05 | *** |
All Areas | no/dead-top | Dist from Mean AF | 812 | 0.2386 |     0.0688  | 3.468 | 0.000525 | *** |
All Areas | no/thinning | Dist from Mean AF | 855 | 0.12305 |   0.04641 |   2.651 | 0.00802 | ** |
|            |            |            |            |            |            |            |            |            |

## Co Factors 


### Size

| Area       | Response   | Explanatory| df.resid  | Estimate   | Std.Error  | z-val       | Pr(>z)     | Signif.    |
|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|
All Areas | healthy/unhealthy | Dist from Mean AF | 876 | 0.13074  |  0.03459|   3.779| 0.000157| ***|
All Areas | healthy/unhealthy | Tree.Size.Medium  | 876 | 0.28156  |  0.15542  | 1.812 |0.070034| .|
All Areas | healthy/unhealthy | Tree.Size.Small   | 876 | -0.63900  |   0.33293|  -1.919 | 0.054947 |.| 
All Areas | no/dead-top | Dist from Mean AF | 634 | 0.15033  |  0.07431 |  2.023 | 0.04307 | * | 
All Areas | no/dead-top | Tree.Size.Medium | 634 | 0.85568   | 0.27103  | 3.157 | 0.00159 | ** |
All Areas | no/dead-top | Tree.Size.Small | 634 | 0.28621  |  0.48528 |  0.590 | 0.55533|  |
All Areas | no/thinning | Dist from Mean AF | 694 |  0.12852  |  0.04909 |  2.618 |  0.00884 | ** |
All Areas | no/thinning | Tree.Size.Medium | 694 | 0.19655  |  0.21049 |  0.934 | 0.35042 | |
All Areas | no/thinning | Tree.Size.Small | 694 | -1.28676 |   0.61263 | -2.100 | 0.03569| * |
|            |            |            |            |            |            |            |            |            |


### Location


| Area       | Response   | Explanatory| df.resid  | Estimate   | Std.Error  | z-val       | Pr(>z)     | Signif.    |
|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|
All Areas | healthy/unhealthy | Dist from Mean AF | 905 |  0.14851 | 0.03594 |4.132 |3.6e-05 | *** |
All Areas | healthy/unhealthy | Inside a forest canopy  | 905 | -0.04090| 0.36106|   -0.113|  0.910 ||
All Areas | healthy/unhealthy | Roadside   | 905 | 0.09457 | 0.33588 |0.282 |0.778 ||
All Areas | healthy/unhealthy | Urban yard or open park grounds | 905 | -0.40163| 0.32497| -1.236 | 0.216 ||
All Areas | no/dead-top | Dist from Mean AF |667| 0.21257 |0.07773 | 2.735| 0.00624 | ** |
All Areas | no/dead-top | Inside a forest canopy  |667| -0.45747 | 0.48784| -0.938 | 0.34837 | | 
All Areas | no/dead-top | Roadside|667| -1.10304 | 0.48802 | -2.260 | 0.02381 | * |
All Areas | no/dead-top | Urban yard or open park grounds |667| -1.08256  | 0.44487 | -2.433 | 0.01496 | * |
All Areas | no/thinning | Dist from Mean AF | 712 | 0.12110 | 0.05168 | 2.343 | 0.019122 | * |
All Areas | no/thinning | Inside a forest canopy | 712 | 0.47285 | 0.69207| 0.683 | 0.494456 ||
All Areas | no/thinning | Roadside | 712 | 1.24642 | 0.63806| 1.953 |0.050764 |. | 
All Areas | no/thinning | Urban yard or open park grounds | 712 | 0.55728 |0.63278| 0.881 | 0.378491 ||
|            |            |            |            |            |            |            |            |            |


