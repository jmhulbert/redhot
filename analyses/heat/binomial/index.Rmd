---
title: "Binomial Distribution Response to Urban Heat"
author: "Joey Hulbert"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

|            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|
|[Welcome](https://jmhulbert.github.io/redhot)|[Data](https://jmhulbert.github.io/redhot/data)|[Analyses](https://jmhulbert.github.io/redhot/analyses)|[Discussion](https://jmhulbert.github.io/redhot/discussion)|
|             |           |            |            |


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(knitr)
library(kableExtra)
library(gghalves)
library(patchwork)
library(scales)
library(glmmTMB)
library(bbmle)
library(DHARMa)
```


# Purpose

The purpose of this page is to summarize an investigation of **tree health categories** as a *categorical* response to urban heat (temperatures).

Response variable: category: *healthy, unhealthy*


# Read Data

```{r}
data <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot/main/data/urban-data-modified.csv')
```

# Wrangle Data

## Remove dead trees

```{r}
# Remove Dead Trees
data.w.dead <- data 
data <- data %>% filter(field.tree.canopy.symptoms!="Tree is dead") %>% filter(field.dieback.percent<100) %>% droplevels()
```

```{r}
data$binary.tree.canopy.symptoms <- as.factor(data$binary.tree.canopy.symptoms)
levels(data$binary.tree.canopy.symptoms)
```

```{r}
ggplot(data,aes(binary.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
ggplot(data,aes(reclassified.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
data$top.dieback <- as.factor(data$top.dieback)
data$thinning <- as.factor(data$thinning)
```


# Analyses

## Fit Models

```{r}
binomial.daily <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.daily + (1|Area),family=binomial,data=data)
binomial.am <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.am + (1|Area),data=data,family=binomial)
binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
binomial.pm <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.pm + (1|Area),data=data,family=binomial)
```

## Compare Models

```{r}
AICtab(binomial.daily,binomial.am,binomial.af,binomial.pm)
```

Afternoon heat was the best fit

## Model 1: health and heat

```{r}
#binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
```


### Summary

```{r}
summary(binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$binary.tree.canopy.symptoms)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data$predicted_response <- predict(binomial.af, newdata = new.data, type = "response")
```

```{r}
ggplot(new.data, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```

The probability of tree being classified as unhealthy increases with distance from mean af

## Model 2: top dieback and heat

```{r}

top.dieback.binomial.af <- glmmTMB(top.dieback ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
```

### Summary

```{r}
summary(top.dieback.binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$top.dieback)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.2 <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data.2$predicted_response <- predict(top.dieback.binomial.af, newdata = new.data.2, type = "response")
```

```{r}
ggplot(new.data.2, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```


## Model 3: thinning and heat

```{r}
thinning.binomial.af <- glmmTMB(thinning ~ dist.from.mean.af + (1|Area),data=data,family=binomial)
```

### Summary

```{r}
summary(thinning.binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$thinning)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.3 <- expand.grid(
  dist.from.mean.af = seq(min(data$dist.from.mean.af), max(data$dist.from.mean.af), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data.3$predicted_response <- predict(thinning.binomial.af, newdata = new.data.3, type = "response")
```

```{r}
ggplot(new.data.3, aes(x = dist.from.mean.af, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Predicted Response") +
  theme_minimal()
```


## Compare Models

### Odds Ratios

Unhealthy Trees

```{r}

# Unhealthy Overall
coef(binomial.af)
exp(0.1487527)
```

Top Dieback

```{r}
# Top Dieback
coef(top.dieback.binomial.af)
exp(0.2046919)
```


Thinning

```{r}
# Thinning
coef(thinning.binomial.af)
exp(0.08554814)
```


> "An odds ratio greater than 1 implies that the predictor increases the odds of the outcome." 

Heat had the largest effect on predicting if trees had top dieback


## Adding co-variates

### Site

```{r}
data.site.filter <- data %>% filter(field.optional...site.location.description!="" & field.optional...site.location.description!="No Selection" & field.optional...site.location.description!="Other") %>% droplevels()
levels(as.factor(data.site.filter$field.optional...site.location.description))
```


```{r}
ggplot(data.site.filter,aes(field.optional...site.location.description))+geom_histogram(stat="count")+coord_flip()+theme_bw()
```


### Size


```{r}
data.size.site.filter <- data.site.filter %>% filter(field.optional...tree.size!="" & field.optional...tree.size!="No selection")
levels(as.factor(data.size.site.filter$field.optional...tree.size))
```

```{r}
ggplot(data.size.site.filter,aes(field.optional...tree.size))+geom_histogram(stat="count")+coord_flip()+theme_bw()
```






## Model 4: health and heat - filtered data

```{r}
binomial.af.size.site <- glmmTMB(binary.tree.canopy.symptoms ~ dist.from.mean.af + field.optional...site.location.description + field.optional...tree.size +(1|Area),data=data.size.site.filter,family=binomial)
```


### Summary

```{r}
summary(binomial.af)
```


