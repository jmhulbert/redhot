---
title: "Urban redcedar - original exploratory analyses"
author: "Joey Hulbert"
date: "2023-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(corrplot)
library(knitr)
library(kableExtra)
library(gghalves)
library(patchwork)
library(scales)
library(glmmTMB)
library(bbmle)
library(DHARMa)
```


# Intro

The RedHot analysis was completed to compare the health of western redcedar across urban heat islands. Redcedar health data were collected by community scientists in the [Western Redcedar Dieback Map](https://www.inaturalist.org/projects/western-redcedar-dieback-map) project on iNaturalist. Urban heat data were commissioned by three cities in the northwest using methods described in [Voelkel and Shandas (2017)](https://www.mdpi.com/2225-1154/5/2/41). 

# Methods

## Data Descriptions

Observations of western redcedar were downloaded from iNaturalist and urban heat data were downloaded from open data portals or provided by contacts in the City of Tacoma, King County (Washington) and Portland. Trees in WA were also evaluated based on EHD Ranks. HOLC data were also investigated for each city. 


### iNaturalist

* iNaturalist data were downloaded from the Western Redcedar Dieback Map on 1.13.24:
    + full data (query: quality_grade=any&identifications=any%projects%5B%5D=western-redcedar-dieback-map)
      + Note we needed to specify all fields related to place and all fields related to the project



```{r include=FALSE}
# Full Queries
# Query quality_grade=any&identifications=any&projects[]=western-redcedar-dieback-map 
# Columns id, observed_on_string, observed_on, time_observed_at, time_zone, user_id, user_login, user_name, created_at, updated_at, quality_grade, license, url, image_url, sound_url, tag_list, description, num_identification_agreements, num_identification_disagreements, captive_cultivated, oauth_application_id, place_guess, latitude, longitude, positional_accuracy, private_place_guess, private_latitude, private_longitude, public_positional_accuracy, geoprivacy, taxon_geoprivacy, coordinates_obscured, positioning_method, positioning_device, place_town_name, place_county_name, place_state_name, place_country_name, place_admin1_name, place_admin2_name, species_guess, scientific_name, common_name, iconic_taxon_name, taxon_id, field:tree+canopy+symptoms, field:optional+-+did+the+tree+have+heat+damage, field:percent+canopy+affected+%28%25%29, field:dieback+percent, field:number+of+additional+unhealthy+trees+%28of+same+species%29+in+area+%28within+sight%29, field:percent+of+trees+%28of+same+species%29+within+sight+that+are+unhealthy, field:other+factors+-+are+there+signs+or+symptoms+of+insect%2C+diseases%2C+or+other+damage%3F, field:optional+-+what+%27other+factors%27+were+observed%3F, field:optional+-+tree+size, field:optional+-+site+type, field:optional+-+site%2Flocation+description, field:optional+-+site%2Farea+disturbance+level, field:optional+-+site+hydrology, field:optional+-+access+to+water, field:optional+-+slope+position, field:optional+-+were+there+any+other+unhealthy+plant+species+on+the+site%3F, field:optional+-+timing+of+symptoms+estimate, field:optional+-+estimated+time+spent+to+make+this+observation+%28%23+of+minutes%29, field:optional+-+can+we+follow+up+with+you%3F, field:tree+number+%28from+google+map%29+if+applicable, field:notes 

# Seattle Tacoma Metro - Query quality_grade=any&identifications=any&place_id=122789&projects[]=western-redcedar-dieback-map Columns id, observed_on_string, observed_on, time_observed_at, time_zone, user_id, user_login, user_name, created_at, updated_at, quality_grade, license, url, image_url, sound_url, tag_list, description, num_identification_agreements, num_identification_disagreements, captive_cultivated, oauth_application_id, place_guess, latitude, longitude, positional_accuracy, private_place_guess, private_latitude, private_longitude, public_positional_accuracy, geoprivacy, taxon_geoprivacy, coordinates_obscured, positioning_method, positioning_device, place_town_name, place_county_name, place_state_name, place_country_name, place_admin1_name, place_admin2_name, species_guess, scientific_name, common_name, iconic_taxon_name, taxon_id, field:tree+canopy+symptoms, field:optional+-+did+the+tree+have+heat+damage, field:percent+canopy+affected+%28%25%29, field:dieback+percent, field:number+of+additional+unhealthy+trees+%28of+same+species%29+in+area+%28within+sight%29, field:percent+of+trees+%28of+same+species%29+within+sight+that+are+unhealthy, field:other+factors+-+are+there+signs+or+symptoms+of+insect%2C+diseases%2C+or+other+damage%3F, field:optional+-+what+%27other+factors%27+were+observed%3F, field:optional+-+tree+size, field:optional+-+site+type, field:optional+-+site%2Flocation+description, field:optional+-+site%2Farea+disturbance+level, field:optional+-+site+hydrology, field:optional+-+access+to+water, field:optional+-+slope+position, field:optional+-+were+there+any+other+unhealthy+plant+species+on+the+site%3F, field:optional+-+timing+of+symptoms+estimate, field:optional+-+estimated+time+spent+to+make+this+observation+%28%23+of+minutes%29, field:optional+-+can+we+follow+up+with+you%3F, field:notes 

#King County - Query quality_grade=any&identifications=any&place_id=1282&projects[]=western-redcedar-dieback-map Columns id, observed_on_string, observed_on, time_observed_at, time_zone, user_id, user_login, user_name, created_at, updated_at, quality_grade, license, url, image_url, sound_url, tag_list, description, num_identification_agreements, num_identification_disagreements, captive_cultivated, oauth_application_id, place_guess, latitude, longitude, positional_accuracy, private_place_guess, private_latitude, private_longitude, public_positional_accuracy, geoprivacy, taxon_geoprivacy, coordinates_obscured, positioning_method, positioning_device, place_town_name, place_county_name, place_state_name, place_country_name, place_admin1_name, place_admin2_name, species_guess, scientific_name, common_name, iconic_taxon_name, taxon_id, field:tree+canopy+symptoms, field:optional+-+did+the+tree+have+heat+damage, field:percent+canopy+affected+%28%25%29, field:dieback+percent, field:number+of+additional+unhealthy+trees+%28of+same+species%29+in+area+%28within+sight%29, field:percent+of+trees+%28of+same+species%29+within+sight+that+are+unhealthy, field:other+factors+-+are+there+signs+or+symptoms+of+insect%2C+diseases%2C+or+other+damage%3F, field:optional+-+what+%27other+factors%27+were+observed%3F, field:optional+-+tree+size, field:optional+-+site+type, field:optional+-+site%2Flocation+description, field:optional+-+site%2Farea+disturbance+level, field:optional+-+site+hydrology, field:optional+-+access+to+water, field:optional+-+slope+position, field:optional+-+were+there+any+other+unhealthy+plant+species+on+the+site%3F, field:optional+-+timing+of+symptoms+estimate, field:optional+-+estimated+time+spent+to+make+this+observation+%28%23+of+minutes%29, field:optional+-+can+we+follow+up+with+you%3F, field:notes 

# Portland Vancouver Metro - Query quality_grade=any&identifications=any&place_id=81864&projects[]=western-redcedar-dieback-map Columns id, observed_on_string, observed_on, time_observed_at, time_zone, user_id, user_login, user_name, created_at, updated_at, quality_grade, license, url, image_url, sound_url, tag_list, description, num_identification_agreements, num_identification_disagreements, captive_cultivated, oauth_application_id, place_guess, latitude, longitude, positional_accuracy, private_place_guess, private_latitude, private_longitude, public_positional_accuracy, geoprivacy, taxon_geoprivacy, coordinates_obscured, positioning_method, positioning_device, place_town_name, place_county_name, place_state_name, place_country_name, place_admin1_name, place_admin2_name, species_guess, scientific_name, common_name, iconic_taxon_name, taxon_id, field:tree+canopy+symptoms, field:optional+-+did+the+tree+have+heat+damage, field:percent+canopy+affected+%28%25%29, field:dieback+percent, field:number+of+additional+unhealthy+trees+%28of+same+species%29+in+area+%28within+sight%29, field:percent+of+trees+%28of+same+species%29+within+sight+that+are+unhealthy, field:other+factors+-+are+there+signs+or+symptoms+of+insect%2C+diseases%2C+or+other+damage%3F, field:optional+-+what+%27other+factors%27+were+observed%3F, field:optional+-+tree+size, field:optional+-+site+type, field:optional+-+site%2Flocation+description, field:optional+-+site%2Farea+disturbance+level, field:optional+-+site+hydrology, field:optional+-+access+to+water, field:optional+-+slope+position, field:optional+-+were+there+any+other+unhealthy+plant+species+on+the+site%3F, field:optional+-+timing+of+symptoms+estimate, field:optional+-+estimated+time+spent+to+make+this+observation+%28%23+of+minutes%29, field:optional+-+can+we+follow+up+with+you%3F, field:notes 

# full dataset -  Query quality_grade=any&identifications=any&projects[]=western-redcedar-dieback-map Columns id, observed_on_string, observed_on, time_observed_at, time_zone, user_id, user_login, user_name, created_at, updated_at, quality_grade, license, url, image_url, sound_url, tag_list, description, num_identification_agreements, num_identification_disagreements, captive_cultivated, oauth_application_id, place_guess, latitude, longitude, positional_accuracy, private_place_guess, private_latitude, private_longitude, public_positional_accuracy, geoprivacy, taxon_geoprivacy, coordinates_obscured, positioning_method, positioning_device, place_town_name, place_county_name, place_state_name, place_country_name, place_admin1_name, place_admin2_name, species_guess, scientific_name, common_name, iconic_taxon_name, taxon_id, field:tree+canopy+symptoms, field:optional+-+did+the+tree+have+heat+damage, field:percent+canopy+affected+%28%25%29, field:dieback+percent, field:number+of+additional+unhealthy+trees+%28of+same+species%29+in+area+%28within+sight%29, field:percent+of+trees+%28of+same+species%29+within+sight+that+are+unhealthy, field:other+factors+-+are+there+signs+or+symptoms+of+insect%2C+diseases%2C+or+other+damage%3F, field:optional+-+what+%27other+factors%27+were+observed%3F, field:optional+-+tree+size, field:optional+-+site+type, field:optional+-+site%2Flocation+description, field:optional+-+site%2Farea+disturbance+level, field:optional+-+site+hydrology, field:optional+-+access+to+water, field:optional+-+slope+position, field:optional+-+were+there+any+other+unhealthy+plant+species+on+the+site%3F, field:optional+-+timing+of+symptoms+estimate, field:optional+-+estimated+time+spent+to+make+this+observation+%28%23+of+minutes%29, field:optional+-+can+we+follow+up+with+you%3F, field:notes 

```


### Urban Heat

* Urban Heat Island data were obtained for the following locations
  + Portland, OR (downloaded from https://osf.io/eb4tw/ accessed 4.16.22)
  + King County, WA (downloaded from https://osf.io/mz79p/ accessed on 4.16.22)
  + Tacoma, WA (received from City of Tacoma)

Note temperature data is different for each dataset and may have been collected slightly differently. Temperature data will need to be standardized (difference from mean) for each dataset, then temperatures can be compared region wide. 

### Environmental Health Disparity Data

Environmental Health Disparity Rank Data (Full EHD Rank data (v2)) was downloaded on 6.17.23 from https://geo.wa.gov/datasets/WADOH::full-environmental-health-disparities-version-2-extract/explore

Metadata is available in this technical report: https://doh.wa.gov/sites/default/files/2022-07/311-011-EHD-Map-Tech-Report_0.pdf?uid=634dcf4aec2b5


* EHD
  + Environmental Exposures
    + "Diesel_PM2"
    + "Ozone_Conc" 
    + "PM2_5"
    + "Proximity_"
    + "Toxic_Rele"
  + Environmental Effects
    + "Lead_Risk_"
    + "PTSDFs"
    + "PNPL"
    + "PRMP"
    + "PWDIS"
  + Socioeconomic Factors
    + "LEP"
    + "No_HS_Dipl"
    + "POC"
    + "Poverty"
    + "Transporta"
    + "Unaffordab"
    + "Unemployed"
  + Sensitive Populations
    + "CVD"
    + "LBW"

### HOLC Data    

Home Owners Loan Corporation Maps were downloaded from the Mapping Inequality Project at the following links
+ [Tacoma](https://dsl.richmond.edu/panorama/redlining/data/WA-Tacoma)
+ [Portland](https://dsl.richmond.edu/panorama/redlining/data/OR-Portland)
+ [Seattle](https://dsl.richmond.edu/panorama/redlining/data/WA-Seattle)

## Data Wrangle

City tree data were 'joined by attribute' separately so we have 3 different tree datasets to work with or merge.

Also, given the UHI data were extracted with shapefiles, the column names are limited to 10characters. Therefore, exported UHI data only include iNat ID numbers and UHI data. These were then re-merged (see below) with the iNat data to get the remaining columns with proper names.


#### Import

##### Prep for QGIS Data Extracts



```{r}
inat.full <- read.csv("~/ServerFiles/redhot/data/WRDM-full-data-1.13.24.csv")
#tacoma.uhi <- read.csv("~/ServerFiles/redhot/data/WRC-TAC-UHI-Values.csv")
```

Filter data to only include necessary columns 

[1] "id"    
[23] "latitude"                                                                               
[24] "longitude"
[35] "place_town_name"                                                                        
[36] "place_county_name"  


```{r}
inat.full.qgis <- inat.full[c(1,23,24,35,36)]
```

#### Split Data into Areas

```{r}
kc.wrc.qgis <- inat.full.qgis %>% filter(place_county_name=="King")
port.wrc.qgis <- inat.full.qgis %>% filter(place_town_name=="Portland")
tac.wrc.qgis <- inat.full.qgis %>% filter(place_town_name=="Tacoma")
```

* Note: Alternative option is to export iNat observations in these locations rather than export all observations than filter to these locations
    + Tacoma (query: quality_grade=any&identifications=any&place_id=186123&projects%5B%5D=western-redcedar-dieback-map)
    + Portland Metro Area (query: quality_grade=any&identifications=any&place_id=122420&projects%5B%5D=western-redcedar-dieback-map)
    + King County (query: quality_grade=any&identifications=any&place_id=1282&projects%5B%5D=western-redcedar-dieback-map)




Export data for QGIS data joins

```{r}
#write.csv(inat.full.qgis,file="~/ServerFiles/redhot/data/WRDM-full-data-1.13.24-qgis.csv")
#write.csv(kc.wrc.qgis,file="~/ServerFiles/redhot/data/WRDM-King-County-1.13.24-qgis.csv")
#write.csv(port.wrc.qgis,file="~/ServerFiles/redhot/data/WRDM-Portland-1.13.24-qgis.csv")
#write.csv(tac.wrc.qgis,file="~/ServerFiles/redhot/data/WRDM-Tacoma-1.13.24-qgis.csv")
```

Tacoma - 357 Trees
Portland - 465 Trees
King County - 516 Trees

### QGIS Methods

* Import into QGIS
  + Data Source Manager - Delimited Text - Browse to R working directory

```{r eval=FALSE, include=FALSE}
#python input
layerList = QgsProject.instance().layerTreeRoot().findLayers()
for layer in layerList:
    print(layer.name())
```

```{r eval=FALSE, include=FALSE}
#python output
WRDM-full-data-1.13.24-qgis
EHD_Combined_V2
WRDM-Portland-1.13.24-qgis
Portland HOLC 1.13.24
825a_2
825b_2
825c_2
WRDM-Tacoma-1.13.24-qgis
Tacoma HOLC 1.13.24
clip_tac_pm
clip_tac_am
clip_tac_af
WRDM-King-County-1.13.24-qgis
Seattle HOLC 1.13.24
pm_t_f_ranger
am_t_f_ranger
af_t_f_ranger
Hybrid
```

##### Extract Heat Data for Trees

```{r eval=FALSE, include=FALSE}
#Portland AM
processing.run("native:rastersampling", {'INPUT':'delimitedtext://file:///Users/redcedar/ServerFiles/redhot/data/WRDM-Portland-1.13.24-qgis.csv?type=csv&maxFields=10000&detectTypes=yes&xField=longitude&yField=latitude&crs=EPSG:4326&spatialIndex=no&subsetIndex=no&watchFile=no','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/Portland/825a_2.tif','COLUMN_PREFIX':'DN_AM','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Portland.UHI.AM.shp'})
#Portland AF
processing.run("native:rastersampling", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Portland.UHI.AM.shp','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/Portland/825b_2.tif','COLUMN_PREFIX':'DN_AF','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Portland.UHI.AMAF.shp'})
#Portland PM
processing.run("native:rastersampling", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Portland.UHI.AMAF.shp','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/Portland/825c_2.tif','COLUMN_PREFIX':'DN_PM','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Portland.UHI.AMAFPM.shp'})

#King County AM
processing.run("native:rastersampling", {'INPUT':'delimitedtext://file:///Users/redcedar/ServerFiles/redhot/data/WRDM-King-County-1.13.24-qgis.csv?type=csv&maxFields=10000&detectTypes=yes&xField=longitude&yField=latitude&crs=EPSG:4326&spatialIndex=no&subsetIndex=no&watchFile=no','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/King County/All Data_CHW_Seattle KingCounty_093020/rasters_chw_seattle king county_120120/am_t_f_ranger.tif','COLUMN_PREFIX':'DN_AM','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AM.shp'})

#King County AF
processing.run("native:rastersampling", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AM.shp','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/King County/All Data_CHW_Seattle KingCounty_093020/rasters_chw_seattle king county_120120/af_t_f_ranger.tif','COLUMN_PREFIX':'DN_AF','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AMAF.shp'})

#King County PM
processing.run("native:rastersampling", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AMAF.shp','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/King County/All Data_CHW_Seattle KingCounty_093020/rasters_chw_seattle king county_120120/pm_t_f_ranger.tif','COLUMN_PREFIX':'DN_PM','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AMAFPM.shp'})

#Tacoma AM
processing.run("native:rastersampling", {'INPUT':'delimitedtext://file:///Users/redcedar/ServerFiles/redhot/data/WRDM-Tacoma-1.13.24-qgis.csv?type=csv&maxFields=10000&detectTypes=yes&xField=longitude&yField=latitude&crs=EPSG:4326&spatialIndex=no&subsetIndex=no&watchFile=no','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/Tacoma/tac/clip_tac_am.tif','COLUMN_PREFIX':'DN_AM','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AM.shp'})

#Tacoma AF
processing.run("native:rastersampling", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AM.shp','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/Tacoma/tac/clip_tac_af.tif','COLUMN_PREFIX':'DN_AF','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AMAF.shp'})

#Tacoma PM
processing.run("native:rastersampling", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AMAF.shp','RASTERCOPY':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Urban Heat GIS data/Tacoma/tac/clip_tac_pm.tif','COLUMN_PREFIX':'DN_PM','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AMAFPM.shp'})
```


* QGIS - Extract heat data for each point
    + Add Heat Data
      + Tacoma
        + tac_pm.tif
        + tac_am.tif
        + tac_af.tif
      + King County
        + pm_t_f_ranger.tiff
        + af_t_f_ranger.tiff
        + am_t_f_ranger.tiff
      + Portland
        + 825a_2 (am)
        + 825b_2 (af)
        + 825c_2 (pm)
    + Open processing tools panel and search for 'sample raster values' 
      + (View > Panels > processing tools)
      + Sample raster values for each temperature time series and each area (e.g. )
      

```{r eval=FALSE, include=FALSE}
* Alternative (Longer) Version (results in less precise data (temp data are whole numbers))        
      + Vectorize for each heat map
        + For example: Af_heat_index vectorize (Raster > Conversion > Polygonize (Raster to Vector)). 
        + Rename column (DN_TAC_AM, DN_KC_PM, etc). 
        + Export vectorized data as new .shp files (or save as new shape file rather than temporary layor that needs to be exported)
        + (Optional) style - gradient - equal gradient (5 classes, virdis, equal interval each class will equal 2.8 degrees for tac af)
        + Create spatial index for all vectors
          + right click > properties > source > 'create spatial index'
    + Add iNat Data
      + downloaded full iNat data
        + Add delimitated text,  custom deliniation - comma (seems to work better than csv for some reason)
      + Select by location (trees that intersect heat data)
        + Filter tree data to those in areas with UHI heat data
          + export selected as 'RedcedarInTacomaUHI'
        + Filter tree data to those in areas with UHI heat data
          + export selected as 'RedcedarInKingCountyUHI'
            + Add heat data to trees layer
      + Join attributes by location (Vector > Data Management Tools > Join Attributes By Location) x3
        + Trees that intersect with vectorized rasters 
        + Advanced settings - do not filter (mark in in both layers)
          + May get warning: No spatial index exists.. (Create spatial index beforehand if needed)
            + Right click each layer and click 'Create Spatial index' in Source Tab
Extract temp data for trees
        + Complete for each heat layer
    + Filter Data to only include trees with DN data ("DN_TAC_AF" != 'NULL' or "DN_KC_AF" != 'NULL')
      + note if QGIS throws error with ‘null’, you can also try “DN_AF”>0
    + Export layer as .CSV in EPSG 4326 WGS 84
```

##### Extract HOLC Data

* Add HOLC data to trees layers for each city
  + join attributes by location (Vector > Data Management Tools > Join Attributes By Location)
  + e.g. Join features in Portland Trees that *Intersect* by comparing to Portland HOLC 1.13.24
  + Advanced settings - do not filter (mark in in both layers)
          + May get warning: No spatial index exists..
            + Right click each layer and click 'Create Spatial index' in Source Tab
  + Export temporary data for trees


```{r eval=FALSE, include=FALSE}
#Portland HOLC
processing.run("native:joinattributesbylocation", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Portland.UHI.AMAFPM.shp','PREDICATE':[0],'JOIN':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/City of Portland/Portland HOLC 1.13.24.json|layername=Portland HOLC 1.13.24','JOIN_FIELDS':[],'METHOD':0,'DISCARD_NONMATCHING':False,'PREFIX':'','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Portland.UHI.AMAFPM.HOLC.shp'})

#King County HOLC
processing.run("native:joinattributesbylocation", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AMAFPM.shp','PREDICATE':[0],'JOIN':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Seattle HOLC 1.13.24.json|layername=Seattle HOLC 1.13.24','JOIN_FIELDS':[],'METHOD':0,'DISCARD_NONMATCHING':False,'PREFIX':'','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AMAFPM.HOLC.shp'})

#Tacoma HOLC
processing.run("native:joinattributesbylocation", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AMAFPM.shp','PREDICATE':[0],'JOIN':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/City of Tacoma/Tacoma HOLC 1.13.24.json|layername=Tacoma HOLC 1.13.24','JOIN_FIELDS':[],'METHOD':0,'DISCARD_NONMATCHING':False,'PREFIX':'','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AMAFPM.HOLC.shp'})
```



##### Extract EHD Rank Data for Trees 

  + Add EHD RAnk data downloaded on 6.17.23 from https://geo.wa.gov/datasets/WADOH::full-environmental-health-disparities-version-2-extract/explore\
  + Add EHD Data to trees layer
    + join attributes by location (Vector > Data Management Tools > Join Attributes By Location)
    + Advanced settings - do not filter (mark in in both layers)
        + May get warning: No spatial index exists..
          + Right click each layer and click 'Create Spatial index' in Source Tab
    + Export temp data for trees
 

```{r eval=FALSE, include=FALSE}
# King County EHD
processing.run("native:joinattributesbylocation", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AMAFPM.HOLC.shp','PREDICATE':[0],'JOIN':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Washington State/Full_Environmental_Health_Disparities_Version_2_Extract/EHD_Combined_V2.shp','JOIN_FIELDS':[],'METHOD':0,'DISCARD_NONMATCHING':False,'PREFIX':'','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.KingCounty.UHI.AMAFPM.HOLC.EHD.shp'})

# Tacoma EHD
processing.run("native:joinattributesbylocation", {'INPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AMAFPM.HOLC.shp','PREDICATE':[0],'JOIN':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Washington State/Full_Environmental_Health_Disparities_Version_2_Extract/EHD_Combined_V2.shp','JOIN_FIELDS':[],'METHOD':0,'DISCARD_NONMATCHING':False,'PREFIX':'','OUTPUT':'/Users/redcedar/LocalFiles/Academia/PostDoc/GIS/Shape Files/Project Produced/Redhot/WRC.Tacoma.UHI.AMAFPM.HOLC.EHD.shp'})
```

#### Community Hypothesis Test - Tree Selection

* Random Tree Selection for Portland Redhot Hypothesis Test. 
  + Define Project CRS WGS 84 EPSG:4326
  + Add Portland Urban Heat Data
    + GIS > Urban Heat GIS Data > Portland > a, b,c tiffs
    + Convert UHI Raster to shp files x 3
    + Raster > Conversion > Polygonize > Default Settings (DN_AM for morning temps (825a), DN_AF for afternoon etc.)
    + Export temporary 'vectorized' layers to shp files with default crs 
Create Spatial Index for each layer (avoids warning in below joining steps)
    + Right click each layer and click 'Create Spatial index' in Source Tab
Extract temp data for trees
  + Add Street Tree Data
    + Downloaded on 9/25/23 from https://gis-pdx.opendata.arcgis.com/datasets/street-trees/explore?location=45.536304%2C-122.653050%2C12.35
      + Data was updated on 7/31/23
    + Filter street trees to redcedar
      + "Scientific" = 'Thuja plicata'
    + Export to new shape file with default CRS (next steps process faster) 'PortlandStreetRedcedar'
  + Join attributs by location
    + Vector > Data Management Tools > Join Attributes by location
    + Trees that intersect with vectorized rasters
    + Advanced settings - do not filter (mark in both layers)
  + Limit trees to "DBH" > 30 and "DBH" < 40? (leaves 160 trees)
  + Randomly select 100 (drops 60 trees)

Export final .shp files as .csv


Re-import Data after following QGIS Methods


```{r}
tacoma.uhi.holc.ehd  <- read.csv("~/ServerFiles/redhot/data/WRC.Tacoma.UHI.HOLC.EHD-1.13.24.csv")
#king.county.uhi <- read.csv("~/ServerFiles/redhot/data/WRC-KC-UHI-Values.csv")
king.county.uhi.holc.ehd <- read.csv("~/ServerFiles/redhot/data/WRC.KingCounty.UHI.HOLC.EHD-1.13.24.csv")
portland.uhi.holc <- read.csv("~/ServerFiles/redhot/data/WRC.Portland.UHI.HOLC-1.13.24.csv") # does not include ehd data because it is outside of WA
```



#### Join UHI and iNat Data

```{r}
kc.wrc <- left_join(king.county.uhi.holc.ehd,inat.full,by="id")
tac.wrc <- left_join(tacoma.uhi.holc.ehd,inat.full,by="id")
pl.wrc <- left_join(portland.uhi.holc,inat.full,by="id")
```

#### Mutate

> Note we needed to convert Tacoma temps to F to match king county

##### Daily Means

```{r}
tac.wrc <- tac.wrc %>% mutate(DN_AM1=((DN_AM1*1.8)+32),DN_AF1=((DN_AF1*1.8)+32),DN_PM1=((DN_PM1*1.8)+32)) %>% mutate(mean.temp.daily=((DN_AM1+DN_AF1+DN_PM1)/3)) %>% mutate(dist.from.mean.daily=mean.temp.daily-(mean(mean.temp.daily,na.rm=TRUE))) %>% mutate(Area="Tacoma")

kc.wrc <- kc.wrc %>% mutate(mean.temp.daily=((DN_AM1+DN_AF1+DN_PM1)/3)) %>% mutate(dist.from.mean.daily=mean.temp.daily-(mean(mean.temp.daily,na.rm=TRUE))) %>% mutate(Area="King County")

pl.wrc <- pl.wrc %>% mutate(DN_AM1=((DN_AM1*1.8)+32),DN_AF1=((DN_AF1*1.8)+32),DN_PM1=((DN_PM1*1.8)+32)) %>% mutate(mean.temp.daily=((DN_AM1+DN_AF1+DN_PM1)/3)) %>% mutate(dist.from.mean.daily=mean.temp.daily-(mean(mean.temp.daily,na.rm=TRUE))) %>% mutate(Area="Portland")
```

##### Morning Means

```{r}
tac.wrc <- tac.wrc %>% mutate(dist.from.mean.am=DN_AM1-(mean(DN_AM1,na.rm=TRUE)))

kc.wrc <- kc.wrc %>% mutate(dist.from.mean.am=DN_AM1-(mean(DN_AM1,na.rm=TRUE)))

pl.wrc <- pl.wrc %>% mutate(dist.from.mean.am=DN_AM1-(mean(DN_AM1,na.rm=TRUE)))
```
##### Afternoon Means

```{r}
tac.wrc <- tac.wrc %>% mutate(dist.from.mean.af=DN_AF1-(mean(DN_AF1,na.rm=TRUE)))

kc.wrc <- kc.wrc %>% mutate(dist.from.mean.af=DN_AF1-(mean(DN_AF1,na.rm=TRUE)))

pl.wrc <- pl.wrc %>% mutate(dist.from.mean.af=DN_AF1-(mean(DN_AF1,na.rm=TRUE)))
```


##### Evening Means

```{r}
tac.wrc <- tac.wrc %>% mutate(dist.from.mean.pm=DN_PM1-(mean(DN_PM1,na.rm=TRUE)))

kc.wrc <- kc.wrc %>% mutate(dist.from.mean.pm=DN_PM1-(mean(DN_PM1,na.rm=TRUE)))

pl.wrc <- pl.wrc %>% mutate(dist.from.mean.pm=DN_PM1-(mean(DN_PM1,na.rm=TRUE)))
```


#### Merge Data (cities)

```{r}
data <- bind_rows(pl.wrc,tac.wrc,kc.wrc)
```

#### Clean

Some of the iNat project questions changed since it was created so some we need to adjust the answers to be more consistent throughout the project. 

```{r}
data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight. <- as.factor(data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight.)
data$field.optional...what..other.factors..were.observed. <- as.factor(data$field.optional...what..other.factors..were.observed.)
data$field.tree.canopy.symptoms <- as.factor(data$field.tree.canopy.symptoms)
data$field.optional...slope.position <- as.factor(data$field.optional...slope.position)
data$field.optional...site.type <- as.factor(data$field.optional...site.type)
data$field.optional...site.location.description  <- as.factor(data$field.optional...site.location.description )
data$field.optional...tree.size <-as.factor(data$field.optional...tree.size)
```

```{r}
data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight.[data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight.=="4"] <- "4-6"
data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight.[data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight.=="5"] <- "4-6"
data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight.[data$field.number.of.additional.unhealthy.trees..of.same.species..in.area..within.sight.=="2"] <- "2-3"
```

```{r}
data$field.tree.canopy.symptoms[data$field.tree.canopy.symptoms=="Multiple Symptoms"] <-"Multiple Symptoms (please list in Notes)"
data$field.tree.canopy.symptoms[data$field.tree.canopy.symptoms=="multiple symptoms"] <-"Multiple Symptoms (please list in Notes)"
data$field.tree.canopy.symptoms[data$field.tree.canopy.symptoms=="thinning foliage"] <-"Thinning Canopy"
data$field.tree.canopy.symptoms[data$field.tree.canopy.symptoms=="healthy"] <-"Healthy"
data$field.tree.canopy.symptoms[data$field.tree.canopy.symptoms=="dead top"] <-"Old Dead Top (needles already gone)"
```

```{r}
data$field.optional...what..other.factors..were.observed.[data$field.optional...what..other.factors..were.observed.=="Fungal Activitiy (mycelial fans, mushrooms at base, or conks on trunk)"] <-"Fungal Activitiy (mycelial fans, bleeding cankers, mushrooms at base, or conks on trunk)"
data$field.optional...what..other.factors..were.observed.[data$field.optional...what..other.factors..were.observed.=="Needle disease (dieback, checking, blight, etc.)"] <- "Needle or leaf disease (dieback, checking, blight, etc.)"
```

```{r}
data$field.optional...slope.position[data$field.optional...slope.position=="Upper 1/3rd of a slope"] <-"Top of slope"
```

```{r}
data$field.optional...site.type[data$field.optional...site.type=="Urban Natural"] <-"Urban"
data$field.optional...site.type[data$field.optional...site.type=="Urban Landscaped"] <-"Urban"
data$field.optional...site.type[data$field.optional...site.type=="Suburban Natural"] <-"Suburban"
data$field.optional...site.type[data$field.optional...site.type=="Suburban Lanscaped"] <-"Suburban"
data$field.optional...site.type[data$field.optional...site.type=="Natural Forest"] <-"Rural"
```

```{r}
data$field.optional...tree.size[data$field.optional...tree.size=="Large"] <- "Large (too big to wrap arms around trunk)"
data$field.optional...tree.size[data$field.optional...tree.size=="Medium"] <- "Medium (can wrap arms around trunk)"
data$field.optional...tree.size[data$field.optional...tree.size=="Small"] <- "Small (can wrap hands around trunk)"
data$field.optional...tree.size[data$field.optional...tree.size=="Very Large"] <- "Very Large (would take many people to wrap arms around trunk)"
```

```{r}
data$field.optional...site.location.description [data$field.optional...site.location.description =="Yard or open park grounds"] <- "Urban yard or open park grounds"
```

```{r}
data$field.percent.canopy.affected.... <- as.factor(data$field.percent.canopy.affected....)
data$field.percent.canopy.affected....[data$field.percent.canopy.affected....=="1-25% of the crown is unhealthy"] <- "1-29% of the canopy is unhealthy"
data$field.percent.canopy.affected....[data$field.percent.canopy.affected....=="Healthy (0%)"] <- "Healthy, no dieback(0%)"
data$field.percent.canopy.affected....[data$field.percent.canopy.affected....=="Healthy (0% is unhealthy)"] <- "Healthy, no dieback(0%)"
data$field.percent.canopy.affected....[data$field.percent.canopy.affected....=="more than 75% of the crown is unhealthy"] <- "60-99% of the canopy is unhealthy"
data <- data %>% droplevels()




data$Percent.Dieback.Modified[data$field.percent.canopy.affected....=="Healthy, no dieback(0%)"] <- 0
data$Percent.Dieback.Modified[data$field.percent.canopy.affected....=="1-29% of the canopy is unhealthy"] <- 1
data$Percent.Dieback.Modified[data$field.percent.canopy.affected....=="30-59% of the canopy is unhealthy"] <- 30
data$Percent.Dieback.Modified[data$field.percent.canopy.affected....=="60-99% of the canopy is unhealthy"] <- 60
data$Percent.Dieback.Modified[data$field.percent.canopy.affected....=="tree is dead"] <- 100
#data$field.dieback.percent[is.na(data$field.dieback.percent)] <- data$Percent.Dieback.Modified

data$field.percent.canopy.affected....[data$Percent.Dieback.Modified==100] <- "tree is dead" #there were a couple healthy trees with 100 dieback somehow..

has.dieback.percent <- data %>% filter(!is.na(field.dieback.percent))
does.not.have.dieback.percent <- data %>% filter(is.na(field.dieback.percent)) 

does.not.have.dieback.percent$field.dieback.percent <- does.not.have.dieback.percent$Percent.Dieback.Modified
data <- rbind(has.dieback.percent,does.not.have.dieback.percent)

data$field.dieback.percent[data$field.dieback.percent<0] <- 0 # not sure why but there was one -2 percent dieback value

```


##### Reclassify response category variables

```{r}
data <- data %>% filter(field.tree.canopy.symptoms!="Candelabra top or very old spike top (old growth)") %>% mutate(binary.tree.canopy.symptoms=field.tree.canopy.symptoms) %>% mutate(reclassified.tree.canopy.symptoms=field.tree.canopy.symptoms) %>% droplevels()
```

```{r}
binary_level_key <- c("Healthy" = "Healthy", "Thinning Canopy" = "Unhealthy", "New Dead Top (red or brown needles still attached)" = "Unhealthy", "Old Dead Top (needles already gone)" = "Unhealthy", "Tree is dead" = "Unhealthy", "Multiple Symptoms (please list in Notes)" = "Unhealthy", "Extra Cone Crop" = "Unhealthy", "Browning Canopy" = "Unhealthy","Branch Dieback or 'Flagging'" = "Unhealthy", "Other (please describe in Notes)" = "Unhealthy", "Yellowing Canopy" = "Unhealthy")


data$binary.tree.canopy.symptoms <- recode_factor(data$binary.tree.canopy.symptoms, !!!binary_level_key)
#levels(binary$field.tree.canopy.symptoms)
data$binary.tree.canopy.symptoms <- as.factor(data$binary.tree.canopy.symptoms)
```

```{r}
reclassified_level_key <- c("Healthy" = "Healthy", "Thinning Canopy" = "Thinning Canopy", "New Dead Top (red or brown needles still attached)" = "Dead Top", "Old Dead Top (needles already gone)" = "Dead Top", "Tree is dead" = "Tree is Dead", "Multiple Symptoms (please list in Notes)" = "Other", "Extra Cone Crop" = "Other", "Browning Canopy" = "Other","Branch Dieback or 'Flagging'" = "Other", "Other (please describe in Notes)" = "Other", "Yellowing Canopy" = "Other")

data$reclassified.tree.canopy.symptoms <- recode_factor(data$reclassified.tree.canopy.symptoms, !!!reclassified_level_key)
#levels(binary$field.tree.canopy.symptoms)
data$reclassified.tree.canopy.symptoms <- as.factor(data$reclassified.tree.canopy.symptoms)
```

##### Check for outliers in temperature data

###### Afternoon


```{r}
ggplot(data,aes(dist.from.mean.af,field.dieback.percent))+geom_point()+theme_bw()
```

Should we remove these four outliers with less than -8 dist from mean af? 

```{r}
data <- data %>% filter(dist.from.mean.af>(-8))
```

```{r}
ggplot(data,aes(dist.from.mean.af,field.dieback.percent))+geom_point()+theme_bw()
```

###### Morning

```{r}
ggplot(data,aes(dist.from.mean.am,field.dieback.percent))+geom_point()+theme_bw()
```

###### Evening


```{r}
ggplot(data,aes(dist.from.mean.pm,field.dieback.percent))+geom_point()+theme_bw()
```



#### Mutate

###### Convert Percent to Proportion

```{r}
data <- data %>% mutate(field.dieback.prop = (field.dieback.percent/100))
```



#### Filter

##### Remove Dead Trees

```{r}
data.w.dead <- data 
data <- data %>% filter(field.tree.canopy.symptoms!="Tree is dead") %>% filter(field.dieback.percent<100) %>% droplevels()
```

##### Subset WA Data

```{r}
wa.data <- data %>% filter(Environm_1!="") %>% droplevels()
```

##### Subset KC Data

```{r}
kc <- data %>% filter(Area=="King County") %>% filter(field.optional...site.type!="" & field.optional...site.type!="No Selection" & field.optional...site.type!="Not Sure" & field.optional...site.type!="Other")
```


##### Subset HOLC Data

```{r}
holc.data <- data %>% filter(grade!="") %>% droplevels()
```

# Visualization

## Distributions

### Number of trees


```{r}
ggplot(data,aes(Area,stat="count"))+geom_bar()+theme_bw() +labs(x="Area",y="Observations") +coord_flip()
```

```{r eval=FALSE, include=FALSE}
levels(as.factor(wa.data$place_admin1_name)) #state
levels(as.factor(wa.data$place_state_name)) #county
levels(as.factor(wa.data$place_admin2_name)) #county
levels(as.factor(wa.data$place_coun)) #county
levels(as.factor(wa.data$place_town)) #odd names
levels(as.factor(wa.data$place_town_name)) #odd names
levels(as.factor(wa.data$place_guess)) ## full address
```



```{r}
ggplot(wa.data,aes(as.factor(place_town_name)))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
ggplot(kc,aes(field.optional...site.type))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```


### Response Variable

```{r}
ggplot(data,aes(field.dieback.percent))+geom_histogram()+theme_bw() +labs(x="Percent Canopy Dieback")
```


> The data is likely zero inflated


```{r}
ggplot(data,aes(field.dieback.percent))+geom_histogram()+theme_bw() +labs(x="Percent Canopy Dieback") +facet_wrap(~binary.tree.canopy.symptoms)
```

There are some data that need to be cleaned, healthy trees should not have dieback percent of 100.

```{r}
weird.data <- data %>% filter(field.dieback.percent>0 & binary.tree.canopy.symptoms=="Healthy")
```

```{r}
ggplot(data,aes(binary.tree.canopy.symptoms,stat="count"))+geom_bar()+theme_bw() +labs(x="Tree Health Category") 
```

binomial distributions

```{r}
ggplot(data,aes(reclassified.tree.canopy.symptoms,stat="count"))+geom_bar()+theme_bw() +labs(x="Tree Health Category")
```


Ordinal regression, maybe poisson distribution?




### Tree Health Categories


```{r fig.height=8, fig.width=10}
ggplot(data,aes(reclassified.tree.canopy.symptoms,dist.from.mean.daily))+geom_boxplot()+theme_bw() +labs(y="Distance from Mean Temp (Avg Temp - Temp)")|  ggplot(data,aes(reclassified.tree.canopy.symptoms,dist.from.mean.daily))+facet_wrap(~Area,ncol=1)+geom_violin()+theme_bw() +labs(y="Distance from Mean Temp (Temp - Mean Temp)")
```

```{r fig.height=5, fig.width=10}
ggplot(data, aes(x = reclassified.tree.canopy.symptoms, y = field.dieback.percent)) + geom_half_point(aes(color = reclassified.tree.canopy.symptoms), side = "l", size = 0.5, alpha = 0.5) + geom_half_boxplot(aes(fill = reclassified.tree.canopy.symptoms), side = "r") +  scale_y_continuous(labels = label_percent(scale=1)) +
  scale_fill_viridis_d(option = "plasma", end = 0.8) + scale_color_viridis_d(option = "plasma", end = 0.8) +
  guides(color = "none", fill = "none") +  labs(x = "Tree Symptoms", y = "Percent Canopy Dieback") + theme_bw() | 

ggplot(data, aes(x = binary.tree.canopy.symptoms, y = field.dieback.percent)) + geom_half_point(aes(color = binary.tree.canopy.symptoms), side = "l", size = 0.5, alpha = 0.5) + geom_half_boxplot(aes(fill = binary.tree.canopy.symptoms), side = "r") +  scale_y_continuous(labels = label_percent(scale=1)) +
  scale_fill_viridis_d(option = "plasma", end = 0.8) + scale_color_viridis_d(option = "plasma", end = 0.8) +   guides(color = "none", fill = "none") +  labs(x = "Tree Symptoms", y = "Percent Canopy Dieback") + theme_bw() 
```

> Some cleaning is needed, some healthy observations have dieback and some dead trees have 0% dieback. 

```{r}
site.type.data <- data %>% filter(field.optional...site.type!="" & field.optional...site.type!="No Selection" & field.optional...site.type!="Not Sure" & field.optional...site.type!="Other") 

ggplot(site.type.data, aes(x = field.optional...site.type, y = field.dieback.percent)) + geom_half_point(aes(color = field.optional...site.type), side = "l", size = 0.5, alpha = 0.5) + geom_half_boxplot(aes(fill = field.optional...site.type), side = "r") + scale_y_continuous(labels = label_percent(scale=1)) +   scale_fill_viridis_d(option = "plasma", end = 0.8) + scale_color_viridis_d(option = "plasma", end = 0.8) +
  guides(color = "none", fill = "none") + labs(x = "Site Type", y = "Percent Canopy Dieback") + theme_bw()
```

```{r}
ggplot(holc.data, aes(x = grade, y = field.dieback.percent)) + geom_half_point(aes(color = grade), side = "l", size = 0.5, alpha = 0.5) + geom_half_boxplot(aes(fill = grade), side = "r") + scale_y_continuous(labels = label_percent(scale=1)) +   scale_fill_viridis_d(option = "plasma", end = 0.8) + scale_color_viridis_d(option = "plasma", end = 0.8) +
  guides(color = "none", fill = "none") + labs(x = "HOLC Grade", y = "Percent Canopy Dieback") + theme_bw()
```


## Density Plots

### Urban Heat


```{r fig.height=5, fig.width=10}
ggplot(data,aes(dist.from.mean.daily,fill=binary.tree.canopy.symptoms))+geom_density()+theme_bw() +geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +labs(x="Distance from Mean Temp (Temp - Mean Temp)",y="Percent of Observations") +guides(fill="none") | ggplot(data,aes(dist.from.mean.daily,fill=binary.tree.canopy.symptoms))+geom_density()+theme_bw() +geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +labs(x="Distance from Mean Temp (Temp - Mean Temp)",y="Percent of Observations")+facet_wrap(~Area,ncol=1) 
```



```{r fig.height=5, fig.width=10}
#ggplot(data,aes(field.dieback.percent,DN_AF1))+geom_point()+geom_smooth(method=lm)+facet_wrap(~Area)+theme_bw() +labs(y="Afternoon Temperature",x="Percent Canopy Dieback")
```

```{r fig.height=5, fig.width=10}
#ggplot(kc,aes(field.dieback.percent,DN_AF1))+geom_point()+geom_smooth(method=lm)+theme_bw() +labs(title="Overall",y="Afternoon Temperature",x="Percent Canopy Dieback") |
#ggplot(kc,aes(field.dieback.percent,DN_AF1))+geom_point()+geom_smooth(method=lm)+facet_wrap(~field.optional...site.type,ncol=1)+theme_bw() +labs(y="Afternoon Temperature",x="Percent Canopy Dieback")
```


```{r fig.height=5, fig.width=10}
ggplot(kc,aes(dist.from.mean.daily,fill=binary.tree.canopy.symptoms))+geom_density()+theme_bw() +geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +labs(x="Distance from Mean Temp (Temp - Mean Temp)",y="Percent of Observations")+facet_wrap(~field.optional...site.type)
```

```{r}
ggplot(holc.data,aes(dist.from.mean.daily,fill=binary.tree.canopy.symptoms))+geom_density()+theme_bw() +geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +labs(x="Distance from Mean Temp (Temp - Mean Temp)",y="Percent of Observations") +guides(fill="none") | ggplot(holc.data,aes(dist.from.mean.daily,fill=binary.tree.canopy.symptoms))+geom_density()+theme_bw() +geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +labs(x="Distance from Mean Temp (Temp - Mean Temp)",y="Percent of Observations")+facet_wrap(~grade,ncol=1) 
```


```{r}
zeros <- data %>% filter(field.dieback.percent==0)
non.zeros <- data %>% filter(field.dieback.percent>0)

ggplot(zeros,aes(dist.from.mean.daily,))+geom_density()+theme_bw() +geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition") +labs(x="Distance from Mean Temp (Temp - Mean Temp)",y="Percent of Observations") +guides(fill="none")
```



```{r}
ggplot(data,aes(field.dieback.percent,dist.from.mean.daily))+geom_point()+geom_smooth(method=lm)+theme_bw() +labs(y="Distance from Mean (Temp - Mean Temp)",x="Percent Canopy Dieback")
```

```{r}
ggplot(non.zeros,aes(field.dieback.percent,dist.from.mean.daily))+geom_point()+geom_smooth(method=lm)+theme_bw() +labs(y="Distance from Mean (Temp - Mean Temp)",x="Percent Canopy Dieback")
```


### Environmental Exposures

Note we need to remove some outliers

```{r}
wa.data <- wa.data %>% filter(Toxic_Rele<=50000) %>% droplevels()
```


```{r fig.height=5, fig.width=10}
p1 <- ggplot(wa.data,aes(field.dieback.percent,Diesel_PM2)) +geom_point()  +geom_smooth(method=lm) +labs(x="Percent Dieback")  +theme_bw()  
p2 <- ggplot(wa.data,aes(field.dieback.percent,Ozone_Conc)) +geom_point() +geom_smooth(method=lm) +labs(x="Percent Dieback")  +theme_bw()  
p3 <- ggplot(wa.data,aes(field.dieback.percent,PM2_5)) +geom_point()  +geom_smooth(method=lm) +labs(x="Percent Dieback")  +theme_bw()  
p4 <- ggplot(wa.data,aes(field.dieback.percent,Proximity_)) +geom_point()  +geom_smooth(method=lm) +labs(x="Percent Dieback")  +theme_bw()  
p5 <- ggplot(wa.data,aes(field.dieback.percent,Toxic_Rele)) +geom_point() +geom_smooth(method=lm) +labs(x="Percent Dieback", y="Toxic Release from Facilities (RSEI Model)") +theme_bw()  
p6 <- ggplot(wa.data,aes(field.dieback.percent,Environm_2))+geom_point()+geom_smooth(method=lm)+theme_bw()+labs(y="Environmental Health Disparity Rank",x="Percent Dieback")

p1 + p2 + p3 + p4 + p5 + p6
```



# Data Summaries

## Trees per health category

Binary Response (2 categories)

```{r}
data %>% group_by(binary.tree.canopy.symptoms) %>% count()
```
Filtered response (5 categories)

```{r}
data %>% group_by(reclassified.tree.canopy.symptoms) %>% count()
```

## Community scientists

```{r}
data %>% group_by(user_login) %>% count()
```

```{r}
data %>% summarize(n.participants=n_distinct(user_id),n.obs=n())
```


```{r}
wa.data %>% summarize(n.participants=n_distinct(user_id),n.obs=n())
```


```{r}
data %>% group_by(Area) %>% summarize()
```





