---
title: "City Tree Analyses"
author: "Joey Hulbert"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
---

|            |            |            |            |            |
|:----------:|:----------:|:----------:|:----------:|:----------:|
|[Welcome](https://jmhulbert.github.io/redhot)|[Data](https://jmhulbert.github.io/redhot/data)|[Analyses](https://jmhulbert.github.io/redhot/analyses)|[Discussion](https://jmhulbert.github.io/redhot/discussion)|[Maps](https://jmhulbert.github.io/redhot/maps)
|             |           |            |            |            |

|            |            |            | Analyses   |            |            |            |
|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|:----------:|
|[Urban Heat](https://jmhulbert.github.io/redhot/analyses/heat/)|[All Areas](https://jmhulbert.github.io/redhot/analyses/heat/all-areas)|[Portland](https://jmhulbert.github.io/redhot/analyses/heat/portland)|[Tacoma](https://jmhulbert.github.io/redhot/analyses/heat/tacoma)|[King County](https://jmhulbert.github.io/redhot/analyses/heat/king-county)|[iNaturalist](https://jmhulbert.github.io/redhot/analyses/inaturalist/)|[City Inventories]((https://jmhulbert.github.io/redhot/analyses/city-trees/))|
|             |           |            |            |            |            |            |

# CITY INVENTORIES

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(gghalves)
library(patchwork)
library(scales)
library(ggmap)
library(osmdata)
```


# Purpose

# Data Wrangling

## Import Data

```{r}
portland.parks <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot/main/data/Portland.Parks.Trees.AF.csv')
portland.streets <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot/main/data/Portland.Street.Trees.AF.csv')
seattle.combined <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot/main/data/Seattle.Trees.AF.csv')
```

## Tidy Data

```{r}
portland.parks <- portland.parks[c(3,4,6,7,8,14,35,36,40,42:45)]
portland.parks <- portland.parks %>% mutate(city.space="Park")

portland.streets <- portland.streets[c(3,4,5,9,10:19)]
portland.streets <- portland.streets %>% mutate(city.space="Street") %>% rename(DBH=DIAMETER) %>% rename(Functional=FUNCTIONAL)

portland.combined <- full_join(portland.streets,portland.parks,by = join_by(OBJECTID, Condition, DN_AF1, lat, lon, DBH,city.space,Functional)) %>% mutate(city="Portland") %>% mutate(DN_AFc=DN_AF1)

portland.combined$DN_AF1 <- ((portland.combined$DN_AF1 * 1.8) +32)

```

```{r}
seattle.combined <- seattle.combined[c(1:8,11:14,17:19)] %>% mutate(city="Seattle") %>% rename(GlobalID=GLOBALID)

seattle.streets <- seattle.combined %>% filter(Source.Department=="Seattle Department of Transportation") %>% mutate(city.space="Street")
seattle.parks <- seattle.combined %>% filter(Source.Department=="Seattle Parks and Recreation") %>% mutate(city.space="Park")

seattle.combined.back <- rbind(seattle.streets,seattle.parks)
```


# Categorize Trees


* Portland Top-Dieback Probability Categories (10%)
  + Most Concern (>10%): > 88.5
  + Moderate Concern (2.5-10%): 84.32-88.5
  + Lowest Concern (<2.5%): <84.32 

* Portland Dieback Probability Cateogories (25%)
  + Most Concern (>25%): >91.66
  + Moderate Concern (5-25%): 86.48- 91.66
  + Lowest Concern (<5%): <86.48

```{r}
portland.most <- portland.combined %>% filter(DN_AF1>88.5)%>% mutate(Category1="Most Concern") %>% droplevels()
portland.mod <- portland.combined %>% filter(DN_AF1>84.32 & DN_AF1<88.5) %>% mutate(Category1="Moderate Concern") %>% droplevels()
portland.low <- portland.combined %>% filter(DN_AF1<84.32) %>% mutate(Category1="Lowest Concern") %>% droplevels()

portland.combined.cat <- bind_rows(list(portland.low,portland.mod,portland.most))

portland.most <- portland.combined.cat %>% filter(DN_AF1>86.5)%>% mutate(Category1Plus2="Most Concern") %>% droplevels()
portland.mod <- portland.combined.cat %>% filter(DN_AF1>82.32 & DN_AF1<86.5) %>% mutate(Category1Plus2="Moderate Concern") %>% droplevels()
portland.low <- portland.combined.cat %>% filter(DN_AF1<82.32) %>% mutate(Category1Plus2="Lowest Concern") %>% droplevels()

portland.combined.cat <- bind_rows(list(portland.low,portland.mod,portland.most))

portland.most <- portland.combined.cat %>% filter(DN_AF1>91.66)%>% mutate(Category25="Most Concern") %>% droplevels()
portland.mod <- portland.combined.cat %>% filter(DN_AF1>86.48 & DN_AF1<91.66) %>% mutate(Category25="Moderate Concern") %>% droplevels()
portland.low <- portland.combined.cat %>% filter(DN_AF1<86.48) %>% mutate(Category25="Lowest Concern") %>% droplevels()


portland.combined.cat <- bind_rows(list(portland.low,portland.mod,portland.most))
```




* King County Top-Dieback Probability Categories (10%)
  + Most Concern (>10%): >87.8
  + Moderate Concern (2.5-10%): 85.22-87.8
  + Lowest Concern (<2.5%): <85.22 
  
* King County Top-Dieback Probability Categories (25%)  
  + Most Concern (>25%): 89.78
  + Moderate Concern (5-25%): 86.5 - 89.78 
  + Lowest Concern (<5%): <86.5


```{r}

seattle.most <- seattle.combined.back %>% filter(DN_AF1>87.8)%>% mutate(Category1="Most Concern") %>% droplevels()
seattle.mod <- seattle.combined.back %>% filter(DN_AF1>85.22 & DN_AF1<87.8) %>% mutate(Category1="Moderate Concern") %>% droplevels()
seattle.low <- seattle.combined.back %>% filter(DN_AF1<85.22) %>% mutate(Category1="Lowest Concern") %>% droplevels()

seattle.combined.cat <- bind_rows(list(seattle.low,seattle.mod,seattle.most))

seattle.most <- seattle.combined.cat %>% filter(DN_AF1>85.8)%>% mutate(Category1Plus2="Most Concern") %>% droplevels()
seattle.mod <- seattle.combined.cat%>% filter(DN_AF1>83.22 & DN_AF1<85.8) %>% mutate(Category1Plus2="Moderate Concern") %>% droplevels()
seattle.low <- seattle.combined.cat %>% filter(DN_AF1<83.22) %>% mutate(Category1Plus2="Lowest Concern") %>% droplevels()

seattle.combined.cat <- bind_rows(list(seattle.low,seattle.mod,seattle.most))

seattle.most <- seattle.combined.cat %>% filter(DN_AF1>89.78)%>% mutate(Category25="Most Concern") %>% droplevels()
seattle.mod <- seattle.combined.cat %>% filter(DN_AF1>86.5 & DN_AF1<89.78) %>% mutate(Category25="Moderate Concern") %>% droplevels()
seattle.low <- seattle.combined.cat%>% filter(DN_AF1<86.5) %>% mutate(Category25="Lowest Concern") %>% droplevels()

seattle.combined.cat <- bind_rows(list(seattle.low,seattle.mod,seattle.most))
```

87 trees in Seattle did not have UHI data. 1 tree in Portland did not have UHI data. 


## Join City Data

```{r}
cities <- full_join(seattle.combined.cat,portland.combined.cat,by = join_by(OBJECTID, DBH, DN_AF1, lat, lon, city, city.space,GlobalID,Category1,Category1Plus2,Category25))
```

# Summarize Data


```{r}
summary <- cities %>% group_by(city,Category1) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary
```

```{r}
ggplot(summary,aes(n,Category1,fill=Category1))+geom_col(alpha=0.7) +facet_wrap(~city) +theme_bw() + scale_fill_manual(name="Category",values=c("#7fcdbb","#fe9929","#DDA0DD")) +labs(x="Number of Trees",y="Concern Category") +guides(fill="none")
```

```{r}
summary <- cities %>% group_by(city,city.space,Category1) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary
```

```{r}
ggplot(summary,aes(n,city.space,fill=Category1))+geom_col(position=position_dodge(),alpha=0.7) +facet_wrap(~city) +theme_bw() + scale_fill_manual(name="Category",values=c("#7fcdbb","#fe9929","#DDA0DD")) +labs(x="Number of Trees",y="Tree Inventory")
```

```{r}
summary <- cities %>% group_by(city,Category1) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary
```


# Portland

```{r portland-concern-histogram, fig.height=5, fig.width=5}
pp <- ggplot(portland.combined.cat, aes(x=DN_AF1))+geom_histogram() +theme_bw() +labs(y="Number of Trees",x="Afternoon Temperature (F)")
pp2 <- pp + annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = -Inf, xmax = 84.32, fill = alpha('#DDA0DD',0.5)) +
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = 84.32, xmax = 88.5, fill = alpha('#7fcdbb',0.5)) + 
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
          xmin = 88.5, xmax = Inf, fill = alpha('#fe9929',0.5))
pp3 <- pp2 + annotate("text", x=82.3, y=280, label= "Lowest\nConcern") + annotate("text", x=86.3, y=280, label= "Moderate\nConcern") + annotate("text", x=90.1, y=280, label= "Most\nConcern")
pp3
```



```{r}
summary1 <- portland.combined.cat %>% group_by(city.space,Category1) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary1
```

```{r}
summary1Plus2 <- portland.combined.cat %>% group_by(city.space,Category1Plus2) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary1
```

```{r}
summary25 <- portland.combined.cat %>% group_by(city.space,Category25) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary25
```



```{r}
pp10 <- ggplot(summary1,aes(n,city.space,fill=Category1))+geom_col(position=position_dodge(),alpha=0.7) +theme_bw() + scale_fill_manual(name="Category 1",values=c("#7fcdbb","#fe9929","#DDA0DD")) +labs(title="0.1",x="Number of Trees",y="Tree Inventory")+guides(fill=FALSE)
```

```{r}
pp11 <- ggplot(summary1Plus2,aes(n,city.space,fill=Category1Plus2))+geom_col(position=position_dodge(),alpha=0.7) +theme_bw() + scale_fill_manual(name="Category 1 plus 2",values=c("#7fcdbb","#fe9929","#DDA0DD")) +labs(title="0.1 plus 2",x="Number of Trees",y="Tree Inventory") +guides(fill=FALSE)
```

```{r}
pp12 <- ggplot(summary25,aes(n,city.space,fill=Category25))+geom_col(position=position_dodge(),alpha=0.7) +theme_bw() + scale_fill_manual(name="Category 25",values=c("#7fcdbb","#fe9929","#DDA0DD")) +labs(title="0.25",x="Number of Trees",y="Tree Inventory")
```


```{r portland-tree-count-concern, fig.height=5, fig.width=10}
pp10 | pp11 | pp12
```


## Portland Map

```{r}
portbb <- c(left = min(portland.combined.cat$lon), 
                              bottom = min(portland.combined.cat$lat), 
                              right = max(portland.combined.cat$lon), 
                              top = max(portland.combined.cat$lat))
```


```{r}
portmap <- get_map(portbb, zoom = 11, scale = 2, maptype="terrain",source="google")
```

```{r}
portland.map <- ggmap(portmap) + geom_point(data = portland.combined.cat, aes(x = lon, y = lat,fill=DN_AF1), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_viridis_c(option = "inferno")+labs(title="Portland",x="Longitude",y="Latitude",fill="Afternoon\nTemp (F)") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```

```{r portland-map, fig.height=7, fig.width=7}
portland.map
```


```{r}
portland.map.cat1 <- ggmap(portmap) + geom_point(data = portland.combined.cat, aes(x = lon, y = lat,fill=Category1), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929"))+labs(title="Portland",x="Longitude",y="Latitude",fill="Conservation\nCategory") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```

```{r}
portland.map.cat1Plus2 <- ggmap(portmap) + geom_point(data = portland.combined.cat, aes(x = lon, y = lat,fill=Category1Plus2), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929"))+labs(title="Portland",x="Longitude",y="Latitude",fill="Conservation\nCategory") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```

```{r}
portland.map.cat25 <- ggmap(portmap) + geom_point(data = portland.combined.cat, aes(x = lon, y = lat,fill=Category25), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929"))+labs(title="Portland",x="Longitude",y="Latitude",fill="Conservation\nCategory") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```


```{r portland-map-concern, fig.height=7, fig.width=7}
portland.map.cat1
```

```{r}
portland.map.cat1 <- portland.map.cat1  +labs(title="0.1 Probability") + theme(legend.position = "none")
portland.map.cat1Plus2 <- portland.map.cat1Plus2  +labs(title="0.1 Probability at 2 degrees higher") + theme(axis.title.y = element_blank())
portland.map.cat1Plus2.1 <- portland.map.cat1Plus2  +labs(title="0.1 Probability at 2 degrees higher") + theme(legend.position = "none",axis.title.y = element_blank())
portland.map.cat25 <-  portland.map.cat25  +labs(title="0.25 Probability") + theme(axis.title.y = element_blank())
```

```{r 2-portland-maps-concern, fig.height=5, fig.width=8}
portland.map.cat1 + portland.map.cat1Plus2
```


```{r 3-portland-maps-concern, fig.height=5, fig.width=10}
portland.map.cat1 + portland.map.cat1Plus2.1 + portland.map.cat25
```

# Seattle

```{r seattle-concern-historgram, fig.height=5, fig.width=5}
sp <- ggplot(seattle.combined.cat, aes(x=DN_AF1))+geom_histogram() +theme_bw() +labs(y="Number of Trees",x="Afternoon Temperature (F)")
sp2 <- sp + annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = -Inf, xmax = 84.32, fill = alpha('#DDA0DD',0.5)) +
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = 84.32, xmax = 88.5, fill = alpha('#7fcdbb',0.5)) + 
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
          xmin = 88.5, xmax = Inf, fill = alpha('#fe9929',0.5))
sp3 <- sp2 + annotate("text", x=82.9, y=280, label= "Lowest\nConcern") + annotate("text", x=86.3, y=280, label= "Moderate\nConcern") + annotate("text", x=90.1, y=280, label= "Most\nConcern")
sp3
```



```{r}
summary1 <- seattle.combined.cat %>% group_by(city.space,Category1) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary1
```

```{r}
summary1Plus2 <- seattle.combined.cat %>% group_by(city.space,Category1Plus2) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary1
```

```{r}
summary25 <- seattle.combined.cat %>% group_by(city.space,Category25) %>% summarize(n=n(),meanAF=mean(DN_AF1,na.rm=TRUE),n_AF_na=sum(is.na(DN_AF1)))
summary25
```



```{r}
sp10 <- ggplot(summary1,aes(n,city.space,fill=Category1))+geom_col(position=position_dodge(),alpha=0.7) +theme_bw() + scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929")) +labs(title="0.10",x="Number of Trees",y="Tree Inventory") +guides(fill=FALSE)
```

```{r}
sp11 <- ggplot(summary1Plus2,aes(n,city.space,fill=Category1Plus2))+geom_col(position=position_dodge(),alpha=0.7) +theme_bw() + scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929")) +labs(title="0.1 Plus 2",x="Number of Trees",y="Tree Inventory") +guides(fill=FALSE)
```



```{r}
sp12 <- ggplot(summary25,aes(n,city.space,fill=Category25))+geom_col(position=position_dodge(),alpha=0.7) +theme_bw() + scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929")) +labs(title="0.25",x="Number of Trees",y="Tree Inventory") 
```

```{r seattle-tree-count-concerns, fig.height=5, fig.width=10}
sp10 | sp11 | sp12
```


## Seattle Map

```{r}
seabb <- c(left = min(seattle.combined.cat$lon), 
                              bottom = min(seattle.combined.cat$lat), 
                              right = max(seattle.combined.cat$lon), 
                              top = max(seattle.combined.cat$lat))
```


```{r}
seamap <- get_map(seabb, zoom = 11, scale = 2, maptype="terrain",source="google")
```

```{r}
seattle.map <- ggmap(seamap) + geom_point(data = seattle.combined.cat, aes(x = lon, y = lat,fill=DN_AF1), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_viridis_c(option = "inferno")+labs(title="Seattle",x="Longitude",y="Latitude",fill="Afternoon\nTemp (F)") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```

```{r seattle-map, fig.height=7, fig.width=7}
seattle.map
```


```{r}
seattle.map.cat1 <- ggmap(seamap) + geom_point(data = seattle.combined.cat, aes(x = lon, y = lat,fill=Category1), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929"))+labs(title="Seattle",x="Longitude",y="Latitude",fill="Conservation\nCategory") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```


```{r}
seattle.map.cat1Plus2 <- ggmap(seamap) + geom_point(data = seattle.combined.cat, aes(x = lon, y = lat,fill=Category1Plus2), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929"))+labs(title="Seattle",x="Longitude",y="Latitude",fill="Conservation\nCategory") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```


```{r}
seattle.map.cat25 <- ggmap(seamap) + geom_point(data = seattle.combined.cat, aes(x = lon, y = lat,fill=Category25), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929"))+labs(title="Seattle",x="Longitude",y="Latitude",fill="Conservation\nCategory") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```





```{r seattle-map-concern, fig.height=7, fig.width=7}
seattle.map.cat1
```


```{r}
seattle.map.cat1 <- seattle.map.cat1  +labs(title="0.1 Probability") + theme(legend.position = "none")
seattle.map.cat1Plus2 <- seattle.map.cat1Plus2  +labs(title="0.1 Probability at 2 degrees higher") + theme(axis.title.y = element_blank())
seattle.map.cat1Plus2.1 <- seattle.map.cat1Plus2  +labs(title="0.1 Probability at 2 degrees higher") + theme(legend.position = "none",axis.title.y = element_blank())
seattle.map.cat25 <-  seattle.map.cat25  +labs(title="0.25 Probability") + theme(axis.title.y = element_blank())
```


```{r 2-seattle-maps-concern, fig.height=5, fig.width=8}
seattle.map.cat1 + seattle.map.cat1Plus2
```


```{r 3-seattle-maps-concern, fig.height=5, fig.width=10}
seattle.map.cat1 + seattle.map.cat1Plus2.1 + seattle.map.cat25
```


```{r}
seattle.map.cat1  <- seattle.map.cat1 + theme(plot.title = element_blank())
```


```{r seattle-inventory-concern, fig.height=5, fig.width=10}
seattle.map.cat1 | sp3
```


```{r}
portland.map.cat1  <- portland.map.cat1 + theme(plot.title = element_blank(),legend.position = "none")
```


```{r portland-inventory-concern, fig.height=5, fig.width=10}
portland.map.cat1 | pp3
```



# Combined Areas



```{r}
portland.map.cat1 <- ggmap(portmap) + geom_point(data = portland.combined.cat, aes(x = lon, y = lat,fill=Category1), color = "black",pch=21, size = 3) + theme_minimal() +scale_fill_manual(name="Category",values=c("#DDA0DD","#7fcdbb","#fe9929"))+labs(title="Portland",x="Longitude",y="Latitude",fill="Conservation\nCategory") +theme(plot.title = element_text(size = 14, hjust = .5,face = "bold.italic"))
```


```{r}
seattle.map <- seattle.map + theme(legend.position = "none")
portland.map <- portland.map +theme(axis.title.y = element_blank())
```



```{r combined-maps-seattle, fig.height=5, fig.width=10}
(seattle.map | portland.map)
```


```{r}
portland.map.cat1 <- portland.map.cat1 +theme(axis.title.y = element_blank())
```



```{r combined-maps-portland, fig.height=5, fig.width=10}
(seattle.map.cat1 | portland.map.cat1)
```




```{r}
seattle.map <- seattle.map + theme(legend.position = "none",axis.title.x = element_blank())
seattle.map.cat  <- seattle.map.cat1 + theme(legend.position = "none",plot.title = element_blank())
portland.map <- portland.map +theme(axis.title.x = element_blank(),axis.title.y = element_blank())
portland.map.cat <- portland.map.cat1 +theme(plot.title = element_blank(),axis.title.y = element_blank())


#+ theme(legend.position = "none",,)
```



```{r combined-maps, fig.height=10, fig.width=10}
(seattle.map | portland.map) / (seattle.map.cat | portland.map.cat)
```

